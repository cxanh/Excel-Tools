# 需求文档

## 简介

Excel 工具箱是一个跨平台的桌面应用程序，旨在为用户提供高效的 Excel 文件批量处理能力。该工具支持内容操作、图像处理、文件合并拆分、格式转换和文件属性管理等功能，帮助用户简化日常 Excel 文件处理工作。

## 系统架构概述

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层 (UI_Layer)                  │
│              Electron + Vue.js + Pinia                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │文件选择器│  │功能面板  │  │进度显示  │  │结果展示  ││
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘│
└─────────────────────────────────────────────────────────┘
                          ↕ (IPC - JSON over stdin/stdout)
┌─────────────────────────────────────────────────────────┐
│                 后端处理引擎 (Backend_Engine)             │
│                      Python 3.9+                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │              命令路由器 (CLI Router)              │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │File_Loader│  │File_Saver│  │Content_  │  │Image_    ││
│  │          │  │          │  │Processor │  │Processor ││
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘│
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │Sheet_    │  │Merge_Split│  │Format_   │  │Property_ ││
│  │Manager   │  │_Engine   │  │Converter │  │Manager   ││
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘│
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                    外部依赖                              │
│  openpyxl, pandas, Pillow, LibreOffice (可选)           │
└─────────────────────────────────────────────────────────┘
```

**通信机制说明**:
- 前端通过 Electron 的 `child_process` 模块启动 Python 后端进程
- 使用 JSON 格式通过标准输入输出（stdin/stdout）进行双向通信
- 请求格式: `{"action": "操作名", "params": {...}}`
- 响应格式: `{"status": "success/error", "message": "...", "data": {...}}`
- 错误传递: 后端捕获所有异常，转换为结构化错误响应返回前端

## 术语表

- **Excel_Toolkit**: Excel 工具箱桌面应用程序，整个系统的总称
- **File_Loader**: 文件加载模块，负责加载 Excel 文件（支持 .xls (Excel 97-2003) 和 .xlsx (Excel 2007+) 格式），验证文件有效性，并返回工作簿对象供其他模块使用
- **File_Saver**: 文件保存模块，负责将修改后的工作簿保存为 Excel 文件，支持备份机制、覆盖确认和恢复功能，确保原始文件安全
- **Content_Processor**: 内容处理模块，处理 Excel 文件中的数据内容操作，如删除空白行、清除空白单元格内容、删除公式、删除重复行、按规则替换内容等
- **Image_Processor**: 图像处理模块，处理 Excel 中嵌入的图像，包括提取图片、替换图片和添加水印功能，支持 JPG、PNG、BMP、GIF 等常见格式
- **Sheet_Manager**: 工作表管理模块，负责工作表的插入、删除、重命名和验证操作
- **Merge_Split_Engine**: 合并拆分引擎，处理多个 Excel 或 CSV 文件的合并（支持追加到同一工作表或保留独立工作表），以及单个文件按行数拆分的功能
- **Format_Converter**: 格式转换器，负责将 Excel 文件转换为其他格式（如 PDF、CSV），依赖外部工具（如 LibreOffice）或内置转换逻辑
- **Property_Manager**: 文件属性管理器，管理 Excel 文件的元数据、密码保护（工作簿打开密码和工作表修改密码）和文件优化功能
- **UI_Layer**: 用户界面层，基于 Electron 和 Vue.js 构建，负责展示界面、接收用户输入、显示处理进度和结果，提供文件选择、参数配置、预览和撤销等交互功能
- **Backend_Engine**: 后端处理引擎，基于 Python 3.9+ 构建，包含所有文件处理逻辑，通过 JSON over stdin/stdout 与前端通信，负责命令路由、模块调用和错误处理
- **CLI_Router**: 命令路由器，Backend_Engine 的核心组件，负责解析前端发送的 JSON 命令，路由到相应的处理模块，并将结果封装为 JSON 响应返回

## 需求

### 需求 1: 文件加载

**用户故事:** 作为用户，我希望能够加载 Excel 文件，以便对文件进行各种操作。

#### 验收标准

1. WHEN 用户选择一个 Excel 文件（.xls 或 .xlsx 格式）THEN 系统 SHALL 成功加载该文件并读取所有工作表内容
2. WHEN 文件加载前 THEN 系统 SHALL 验证文件格式是否为支持的类型（.xls (Excel 97-2003) 或 .xlsx (Excel 2007+)）
3. IF 文件加载失败（文件不存在）THEN 系统 SHALL 返回错误代码 FILE_NOT_FOUND 和明确的错误信息
4. IF 文件加载失败（文件损坏）THEN 系统 SHALL 返回错误代码 FILE_CORRUPTED 和明确的错误信息
5. IF 文件加载失败（格式不支持）THEN 系统 SHALL 返回错误代码 FILE_FORMAT_UNSUPPORTED 和明确的错误信息
6. IF 文件加载失败（权限不足）THEN 系统 SHALL 返回错误代码 FILE_PERMISSION_DENIED 和明确的错误信息
7. WHEN 加载超过 100MB 的大文件时 THEN 系统 SHALL 使用流式读取模式以优化内存使用

### 需求 2: 文件保存

**用户故事:** 作为用户，我希望能够安全地保存修改后的文件，以便保留我的工作成果并防止数据丢失。

#### 验收标准

1. WHEN 用户保存修改后的文件 THEN 系统 SHALL 将文件保存为原格式或用户指定的格式
2. WHEN 保存文件前 THEN 系统 SHALL 自动创建原文件的备份到 `.backup` 目录
3. WHEN 保存文件时目标路径已存在同名文件 THEN 系统 SHALL 提示用户确认是否覆盖
4. IF 保存操作失败 THEN 系统 SHALL 自动从备份恢复原文件，确保原文件不被破坏
5. WHEN 备份文件超过 5 个时 THEN 系统 SHALL 自动删除最旧的备份文件
6. WHEN 用户请求恢复备份 THEN 系统 SHALL 显示可用备份列表（包含时间戳）供用户选择

### 需求 3: 内容操作

**用户故事:** 作为用户，我希望能够批量处理 Excel 文件中的内容，以便快速清理和规范化数据。

#### 验收标准

1. WHEN 用户选择"删除空白行"功能 THEN 系统 SHALL 删除当前工作表中所有单元格均为空的行
2. WHEN 用户选择"清除空白单元格内容"功能 THEN 系统 SHALL 清除所有空白单元格的内容但保留单元格结构
3. WHEN 用户选择删除公式功能 THEN 系统 SHALL 将所有公式替换为其计算结果值
4. WHEN 用户选择删除重复行功能 THEN 系统 SHALL 识别并删除当前工作表中完全重复的数据行（不包括表头行）
5. WHEN 用户选择删除重复行功能并指定关键列 THEN 系统 SHALL 仅根据指定列的值判断重复
6. WHEN 用户提供规则进行内容替换 THEN 系统 SHALL 根据规则批量替换匹配的内容，支持以下选项：
   - 普通文本匹配或正则表达式匹配
   - 大小写敏感或不敏感
   - 全词匹配或部分匹配
7. WHEN 用户提供的替换规则包含无效的正则表达式 THEN 系统 SHALL 返回错误代码 REGEX_ERROR 和明确的错误信息
8. WHEN 内容操作完成 THEN 系统 SHALL 保持原有单元格格式（字体、颜色、边框等）不变
9. WHEN 用户执行删除重复行操作 THEN 系统 SHALL 在操作前提示用户将删除的行数和保留的行数

### 需求 4: 图像处理

**用户故事:** 作为用户，我希望能够处理 Excel 文件中的图像，以便提取、替换或添加水印。

#### 验收标准

1. WHEN 用户选择提取图片功能 THEN 系统 SHALL 提取当前工作表或所有工作表中的所有嵌入图片并保存到指定目录
2. WHEN 提取图片时 THEN 系统 SHALL 为每个图片生成唯一的文件名（格式: `工作表名_图片序号.扩展名`）
3. WHEN 用户选择替换图片功能 THEN 系统 SHALL 显示当前工作表中所有图片的列表（包含预览、位置、尺寸），供用户选择要替换的图片
4. WHEN 用户选择要替换的图片并提供新图片 THEN 系统 SHALL 用新图片替换选中的图片，保持原始位置和尺寸
5. WHEN 用户选择添加水印功能 THEN 系统 SHALL 提供以下水印选项：
   - 水印类型：文字水印或图片水印
   - 水印位置：左上、右上、左下、右下、居中、平铺
   - 透明度：0-100%
   - 文字水印额外选项：字体、大小、颜色
6. WHEN 用户选择添加水印功能 THEN 系统 SHALL 在指定的图片上添加水印，并确保水印效果对支持的所有图像格式有效（JPG、PNG、BMP、GIF）
7. IF 提取的图片格式不受支持 THEN 系统 SHALL 尝试转换为 PNG 格式并提示用户
8. WHEN 图片处理完成 THEN 系统 SHALL 保持图片在工作表中的原始位置和尺寸（替换图片时可选择调整尺寸）

### 需求 5: 工作表管理

**用户故事:** 作为用户，我希望能够管理 Excel 文件中的工作表，以便组织和整理数据。

#### 验收标准

1. WHEN 用户选择插入工作表功能 THEN 系统 SHALL 在指定位置插入新的工作表
2. WHEN 插入新工作表时 THEN 系统 SHALL 允许用户指定工作表名称，默认名称为 "Sheet{N}"
3. IF 用户指定的工作表名称已存在 THEN 系统 SHALL 返回错误代码 DUPLICATE_SHEET_NAME 并提示用户修改名称
4. WHEN 用户选择删除工作表功能 THEN 系统 SHALL 删除指定的工作表
5. WHEN 删除工作表时该工作表是文件中唯一的工作表 THEN 系统 SHALL 返回错误代码 LAST_SHEET_ERROR 并阻止删除操作
6. WHEN 删除工作表前 THEN 系统 SHALL 提示用户确认删除操作（显示工作表名称和数据行数）
7. WHEN 用户选择重命名工作表功能 THEN 系统 SHALL 允许用户修改工作表名称

### 需求 6: 文件合并与拆分

**用户故事:** 作为用户，我希望能够合并多个文件或拆分单个文件，以便批量处理大量数据。

#### 验收标准

1. WHEN 用户选择多个 Excel 文件进行合并 THEN 系统 SHALL 提供以下合并选项：
   - 选项 A：将所有文件的数据追加到同一个工作表（按文件顺序）
   - 选项 B：保留每个文件的所有工作表为独立工作表（工作表命名: `文件名_工作表名`）
2. WHEN 用户选择多个 CSV 文件进行合并 THEN 系统 SHALL 将所有 CSV 数据追加到一个文件中
3. WHEN 合并包含表头的文件时 THEN 系统 SHALL 智能识别表头（第一行），仅保留一次表头，后续文件跳过表头行
4. WHEN 合并文件时列结构不一致 THEN 系统 SHALL 提示用户选择处理方式：
   - 选项 A：按列名对齐（缺失列填充空值）
   - 选项 B：按列顺序对齐（忽略列名差异）
   - 选项 C：取消合并操作
5. WHEN 用户选择拆分 Excel 文件并指定每个文件的行数 THEN 系统 SHALL 按指定行数拆分文件，每个拆分文件保留表头行
6. WHEN 用户选择拆分 CSV 文件并指定每个文件的行数 THEN 系统 SHALL 按指定行数拆分文件，每个拆分文件保留表头行
7. WHEN 拆分文件时 THEN 系统 SHALL 使用以下命名规则：`原文件名_part{N}.扩展名`（N 从 1 开始）
8. WHEN 合并或拆分操作完成 THEN 系统 SHALL 显示操作摘要（处理的文件数、总行数、输出文件路径）

### 需求 7: 格式转换

**用户故事:** 作为用户，我希望能够将 Excel 文件转换为其他格式，以便在不同场景下使用。

#### 验收标准

1. WHEN 用户选择将 Excel 转换为 PDF THEN 系统 SHALL 提供以下选项：
   - 转换范围：当前工作表、所有工作表、指定工作表
   - 页面设置：纸张大小、方向（横向/纵向）、缩放比例
2. WHEN 用户选择将 Excel 转换为 PDF THEN 系统 SHALL 生成保持原始布局的 PDF 文件
3. WHEN 用户选择将 Excel 转换为 CSV THEN 系统 SHALL 提供以下选项：
   - 转换范围：当前工作表、所有工作表（每个工作表生成独立 CSV 文件）
   - CSV 分隔符：逗号、分号、制表符、自定义
   - 编码格式：UTF-8、GBK、GB2312
4. WHEN 用户选择将 Excel 转换为 CSV THEN 系统 SHALL 为每个工作表生成独立的 CSV 文件（命名: `原文件名_工作表名.csv`）
5. IF 系统未安装 LibreOffice 或其他必需的格式转换依赖 THEN 系统 SHALL 提示用户安装必要的依赖，并提供以下信息：
   - 依赖名称和版本要求
   - 官方下载链接
   - 安装指引文档链接
6. IF PDF 转换功能不可用（依赖未安装）THEN 系统 SHALL 提供降级方案：将每个工作表导出为图片（PNG）并提示用户
7. WHEN 应用启动时 THEN 系统 SHALL 自动检测必要的依赖是否已安装，并在主界面显示依赖状态
8. WHEN 格式转换完成 THEN 系统 SHALL 通知用户并提供输出文件路径，支持直接打开输出文件或所在目录

### 需求 8: 文件属性管理

**用户故事:** 作为用户，我希望能够管理 Excel 文件的属性，以便保护隐私和优化文件。

#### 验收标准

1. WHEN 用户选择清理元数据功能 THEN 系统 SHALL 删除文件中的以下元数据信息：
   - 作者、最后修改者
   - 创建日期、修改日期
   - 公司、主题、标签
   - 注释和自定义属性
2. WHEN 用户选择保护工作簿功能 THEN 系统 SHALL 提供以下保护选项：
   - 工作簿打开密码：需要密码才能打开文件
   - 工作簿结构保护：防止添加、删除、重命名工作表
3. WHEN 用户选择保护工作表功能 THEN 系统 SHALL 提供以下保护选项：
   - 工作表修改密码：需要密码才能修改工作表内容
   - 保护选项：允许选择单元格、格式化单元格、插入行列等
4. WHEN 设置密码保护时 THEN 系统 SHALL 要求用户输入并确认密码（最少 6 个字符）
5. WHEN 用户选择优化文件功能 THEN 系统 SHALL 执行以下优化操作：
   - 移除未使用的样式和格式
   - 压缩嵌入的图片
   - 移除隐藏的工作表和对象
   - 清理临时数据和缓存
6. WHEN 优化文件完成 THEN 系统 SHALL 显示优化前后的文件大小对比和节省的空间百分比
7. WHEN 用户选择移除密码保护功能 THEN 系统 SHALL 要求用户输入当前密码以验证身份

### 需求 9: 用户界面

**用户故事:** 作为用户，我希望有一个直观易用的界面，以便快速访问所有功能。

#### 验收标准

1. WHEN 用户启动应用程序 THEN 系统 SHALL 显示主界面并列出所有可用功能
2. WHEN 用户点击功能按钮 THEN 系统 SHALL 显示相应的操作面板，用户可以选择必要的参数设置选项（如目标路径、文件格式、替换规则、行数等），并明确标注必填项和可选项
3. WHEN 后台处理任务执行时 THEN 系统 SHALL 显示进度指示器，包括当前进度百分比和当前处理文件名
4. WHEN 操作完成或失败 THEN 系统 SHALL 显示明确的成功或错误消息，错误消息应包含错误原因和建议的解决方案
5. WHEN 用户选择文件 THEN 系统 SHALL 提供文件浏览对话框，并支持多文件选择（用于合并等批量操作）
6. WHEN 用户首次使用某功能时 THEN 系统 SHALL 显示简短的功能说明和使用提示

### 需求 10: 跨平台支持

**用户故事:** 作为用户，我希望应用程序能在不同操作系统上运行，以便在任何环境下使用。

#### 验收标准

1. 系统 SHALL 在 Windows 操作系统（Windows 10 及以上版本）上正常运行
2. 系统 SHALL 在 macOS 操作系统（macOS 11 Big Sur 及以上版本）上正常运行
3. 系统 SHALL 在 Linux 操作系统（Ubuntu 20.04 及以上版本，或其他主流发行版）上正常运行
4. WHEN 应用程序在不同平台运行时 THEN 系统 SHALL 提供一致的用户体验，并保证在 Windows、macOS 和 Linux 系统上都能顺利运行，包括对平台特定的依赖进行适配
5. WHEN 应用程序首次在某平台运行时 THEN 系统 SHALL 自动检测并提示用户安装平台特定的依赖（如 Python 3.9+ 运行时）
6. 系统 SHALL 内嵌 Python 3.9+ 运行时，避免用户手动安装依赖

### 需求 11: 批量操作与任务管理

**用户故事:** 作为用户，我希望能够对多个文件执行相同的操作，并管理操作任务，以便提高工作效率。

#### 验收标准

1. WHEN 用户选择多个文件 THEN 系统 SHALL 允许用户对所有选中文件依次执行相同的操作
2. WHEN 执行批量操作时 THEN 系统 SHALL 显示整体进度（如 "处理中: 3/10 文件"）和当前文件的处理进度
3. WHEN 批量操作中某个文件处理失败 THEN 系统 SHALL 记录错误并继续处理下一个文件
4. WHEN 批量操作完成 THEN 系统 SHALL 显示操作摘要：成功数量、失败数量、失败文件列表
5. WHEN 用户保存常用的操作步骤组合 THEN 系统 SHALL 允许用户创建自定义任务模板（如 "清理数据并转 PDF"）
6. WHEN 用户选择任务模板 THEN 系统 SHALL 自动应用模板中定义的所有操作步骤
7. WHEN 用户执行长时间操作时 THEN 系统 SHALL 允许用户取消操作，并提示是否保留已处理的部分结果

### 需求 12: 操作预览与撤销

**用户故事:** 作为用户，我希望能够在执行破坏性操作前预览结果，并在操作后撤销，以便避免数据丢失。

#### 验收标准

1. WHEN 用户执行删除、替换等破坏性操作前 THEN 系统 SHALL 提供预览功能，显示将受影响的内容（如将删除的行数、将替换的单元格数量）
2. WHEN 用户查看预览时 THEN 系统 SHALL 高亮显示将被修改的内容
3. WHEN 用户确认预览后 THEN 系统 SHALL 执行操作并自动创建撤销点
4. WHEN 用户选择撤销操作 THEN 系统 SHALL 从最近的撤销点恢复文件状态
5. WHEN 用户关闭文件后 THEN 系统 SHALL 清除该文件的撤销历史
6. WHEN 撤销历史超过 10 个操作 THEN 系统 SHALL 自动删除最旧的撤销点

## 非功能性需求

### 性能要求

1. 系统 SHALL 在 5 秒内加载不超过 50MB 的 Excel 文件
2. 系统 SHALL 在 10 秒内加载不超过 100MB 的 Excel 文件
3. 系统 SHALL 在 30 秒内完成对 10000 行数据的删除空白行操作
4. 系统 SHALL 支持处理最多 100 个文件的批量操作
5. 系统 SHALL 在处理大文件（超过 100MB）时保持 UI 响应，不出现假死现象
6. 系统 SHALL 在内存使用超过 1GB 时自动切换到流式处理模式

### 可靠性要求

1. 任何操作失败均不应导致原始文件损坏（通过备份机制保证）
2. 系统 SHALL 在异常退出后自动恢复未保存的工作（通过自动保存机制）
3. 系统 SHALL 在 99% 的情况下正确处理有效的 Excel 文件
4. 系统 SHALL 在遇到不可恢复的错误时提供详细的错误报告和日志

### 兼容性要求

1. 系统 SHALL 支持 .xls (Excel 97-2003) 格式的读取和写入
2. 系统 SHALL 支持 .xlsx (Excel 2007+) 格式的读取和写入
3. 系统 SHALL 支持 .csv 格式的读取和写入
4. 系统 SHALL 保持与 Microsoft Excel 2010 及以上版本的兼容性
5. 系统 SHALL 保持与 LibreOffice Calc 6.0 及以上版本的兼容性

### 安全性要求

1. 密码在内存中加密存储，不写入日志文件
2. 系统 SHALL 验证所有文件路径，防止路径遍历攻击
3. 系统 SHALL 清理所有用户输入，防止命令注入
4. 系统 SHALL 仅访问用户明确选择的文件，不扫描或访问其他文件
5. 日志文件中的敏感信息（如文件路径）SHALL 进行脱敏处理

### 可用性要求

1. 系统 SHALL 提供中文和英文两种语言界面
2. 系统 SHALL 支持键盘快捷键操作（如 Ctrl+O 打开文件、Ctrl+S 保存文件）
3. 系统 SHALL 提供工具提示（Tooltip）解释每个功能按钮的作用
4. 系统 SHALL 在首次启动时提供快速入门向导
5. 错误消息 SHALL 使用用户友好的语言，避免技术术语

### 可维护性要求

1. 系统 SHALL 采用模块化架构，各功能模块独立
2. 系统 SHALL 提供详细的日志记录，便于问题排查
3. 系统 SHALL 支持自动更新功能，检测并安装新版本
4. 系统 SHALL 提供配置文件，允许用户自定义默认设置

### 需求 10: 错误处理与日志

**用户故事:** 作为用户，我希望系统能够妥善处理错误并提供日志，以便排查问题。

#### 验收标准

1. WHEN 任何操作发生错误 THEN 系统 SHALL 捕获异常并返回用户友好的错误信息，包括：
   - 错误类型（如 FILE_NOT_FOUND、OPERATION_FAILED）
   - 错误原因（用户可理解的描述）
   - 建议的解决方案（如 "请检查文件路径是否正确"）
   - 错误上下文（如文件路径、操作类型）
2. WHEN 系统运行时 THEN 系统 SHALL 记录以下信息到日志文件：
   - 操作时间戳（ISO 8601 格式）
   - 文件路径（脱敏处理，仅保留文件名）
   - 操作类型（如 delete_formula、merge_files）
   - 操作结果（成功/失败）
   - 错误代码和错误消息（如果失败）
   - 处理时间（毫秒）
3. IF 文件处理过程中断 THEN 系统 SHALL 保留原始文件不被破坏，并自动从备份恢复
4. WHEN 用户查看日志 THEN 系统 SHALL 提供日志查看功能，支持以下筛选选项：
   - 按时间范围筛选
   - 按错误类型筛选
   - 按文件名筛选
   - 按操作类型筛选
5. WHEN 日志文件超过 10MB THEN 系统 SHALL 自动进行日志轮转，保留最近 5 个日志文件
6. WHEN 系统遇到严重错误（如内存不足、磁盘空间不足）THEN 系统 SHALL 显示紧急错误对话框并安全退出

