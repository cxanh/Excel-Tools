import{P as ue}from"./PluginTemplate-Bk8KtKqf.js";import{r as re}from"./py-lgh_vU0b.js";import{_ as pe,r as f,n as j,b as u,c,d as v,e as n,g as l,f as b,h as H,w as r,i as p,t as m,F as ie,j as de}from"./index-tMO3H4K7.js";const ve={class:"generate-from-template"},me={style:{display:"none"}},fe={key:0,class:"step-content"},ce={class:"ant-upload-drag-icon"},ge={key:0,class:"file-info"},ye={key:1,class:"step-content"},xe={class:"ant-upload-drag-icon"},_e={key:0,class:"file-info"},he={key:2,class:"step-content"},we={key:0,class:"mapping-section"},be={key:1,class:"no-data"},ke={key:3,class:"step-content"},Fe={class:"processing-summary"},Re={key:5,style:{margin:"16px 0"}},Se={__name:"index",setup(Ae){const M=f(null),o=f(0),g=f(null),y=f(null),s=f(null),C=f([]),U=f(!1),x=f(0),a=f([]),$=f(null),I=f(null),i=f({outputFilenameRule:"文档_{序号}.xlsx",dataStartRow:1,templateSheet:""}),T=j(()=>Math.min((s==null?void 0:s.totalRows)||0,100)),O=j(()=>s!=null&&s.columns?s.columns.map(t=>({title:t,dataIndex:t,key:t})):[]),J=async()=>(await fetch("/plugins/generate-from-template/worker.py")).text(),q=()=>{var t,e;o.value===1?(t=$.value)==null||t.click():o.value===2&&((e=I.value)==null||e.click())},G=()=>{a.value.push("从文件夹导入功能开发中...")},K=t=>{switch(t){case"paste":a.value.push("从剪贴板读取功能开发中...");break;case"clear":o.value===1?g.value=null:o.value===2&&(y.value=null,s.value=null);break}},Q=async()=>{if(o.value===0)o.value=1,a.value.push("进入上传模板文件步骤...");else if(o.value===1){if(!g.value){a.value.push("请先上传模板文件");return}o.value=2,a.value.push("进入上传数据源步骤...")}else if(o.value===2){if(!y.value||!s.value){a.value.push("请先上传数据源文件");return}o.value=3,a.value.push("进入字段映射步骤...")}else if(o.value===3){if(!i.value.outputFilenameRule){a.value.push("请设置输出文件名规则");return}o.value=4,a.value.push("进入开始生成步骤...")}else o.value===4&&await P()},W=t=>{},X=t=>{const e=t.target.files[0];e&&D(e),t.target.value=""},D=t=>{g.value=t;const e=new FileReader;return e.onload=R=>{try{C.value=["Sheet1","Sheet2","Sheet3"],i.value.templateSheet=C.value[0],a.value.push("模板文件解析成功")}catch(_){a.value.push(`模板文件解析错误: ${_.message}`),C.value=[]}},e.readAsArrayBuffer(t),!1},Y=t=>{const e=t.target.files[0];e&&Z(e),t.target.value=""},Z=t=>{y.value=t;const e=new FileReader;return e.onload=R=>{try{s.value={columns:["合同编号","客户名称","金额","日期","状态"],sampleData:[{合同编号:"HT001",客户名称:"客户A",金额:1e4,日期:"2026-01-14",状态:"生效"},{合同编号:"HT002",客户名称:"客户B",金额:2e4,日期:"2026-01-15",状态:"生效"},{合同编号:"HT003",客户名称:"客户C",金额:3e4,日期:"2026-01-16",状态:"草稿"}],totalRows:50},a.value.push("数据源文件解析成功")}catch(_){a.value.push(`数据源文件解析错误: ${_.message}`),s.value=null}},e.readAsArrayBuffer(t),!1},P=async()=>{if(!(!g.value||!y.value||!s.value)){U.value=!0,a.value=["开始批量生成文档..."],x.value=10;try{const t=await J();x.value=30,a.value.push(`模板文件: ${g.value.name}`),a.value.push(`数据源文件: ${y.value.name}`),a.value.push(`生成数量: ${T.value} 个文件`),a.value.push(`设置参数: ${JSON.stringify(i.value)}`);const e=new FileReader,R=await new Promise(h=>{e.onload=k=>h(k.target.result),e.readAsArrayBuffer(g.value)});x.value=40;const _=new FileReader,B=await new Promise(h=>{_.onload=k=>h(k.target.result),_.readAsArrayBuffer(y.value)});x.value=50;const A={template:new Uint8Array(R),data:new Uint8Array(B),settings:i.value,dataInfo:s.value};a.value.push("开始批量生成...");const w=await re(t,{type:"other",data:A});if(x.value=80,w.success)if(a.value.push("文档批量生成完成！"),a.value.push(...w.logs),w.data&&w.data.resultFiles)for(const h of w.data.resultFiles){const k=new Blob([h.content],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),S=URL.createObjectURL(k),F=document.createElement("a");F.href=S,F.download=h.filename,document.body.appendChild(F),F.click(),document.body.removeChild(F),URL.revokeObjectURL(S),a.value.push(`生成并下载文件: ${h.filename}`)}else a.value.push("未返回生成的文件数据");else a.value.push(`生成失败: ${w.error}`);x.value=100}catch(t){a.value.push(`错误: ${t.message}`),console.error("Processing error:",t)}finally{U.value=!1}}};return(t,e)=>{var z,N,E,L,V;const R=u("a-icon"),_=u("a-upload-dragger"),B=u("a-tag"),A=u("a-button"),w=u("a-alert"),h=u("a-table"),k=u("a-input"),S=u("a-form-item"),F=u("a-input-number"),ee=u("a-select-option"),le=u("a-select"),te=u("a-form"),ae=u("a-empty"),ne=u("a-progress"),se=u("a-list-item"),oe=u("a-list");return v(),c("div",ve,[n(ue,{"plugin-title":"根据模板生成文档","info-message":"先指定一个 Excel 文档作为模板，然后根据数据源批量生成多个 Excel 文档","current-step":o.value,onAddFile:q,onImportFolder:G,onMoreAction:K,onNextStep:Q,onRemoveFile:W,ref_key:"pluginTemplate",ref:M},null,8,["current-step"]),l("div",me,[l("input",{ref_key:"templateInput",ref:$,type:"file",accept:".xlsx,.xls",onChange:X},null,544),l("input",{ref_key:"dataInput",ref:I,type:"file",accept:".xlsx,.xls,.csv",onChange:Y},null,544)]),o.value===1?(v(),c("div",fe,[e[8]||(e[8]=l("h3",null,"上传Excel模板",-1)),n(_,{name:"file",multiple:!1,"show-upload-list":!1,accept:".xlsx,.xls","before-upload":D},{default:r(()=>[l("p",ce,[n(R,{type:"file-excel",style:{"font-size":"48px",color:"#52c41a"}})]),e[5]||(e[5]=l("p",{class:"ant-upload-text"},"点击或拖拽模板文件到此处上传",-1)),e[6]||(e[6]=l("p",{class:"ant-upload-hint"},"支持 .xlsx, .xls 格式文件",-1))]),_:1}),g.value?(v(),c("div",ge,[n(B,{color:"green",style:{"margin-top":"16px"}},{default:r(()=>[p(m(g.value.name),1)]),_:1}),n(A,{type:"default",style:{"margin-left":"12px"},onClick:e[0]||(e[0]=d=>g.value=null)},{default:r(()=>[...e[7]||(e[7]=[p(" 重新选择 ",-1)])]),_:1})])):b("",!0)])):b("",!0),o.value===2?(v(),c("div",ye,[e[12]||(e[12]=l("h3",null,"上传数据源",-1)),n(_,{name:"file",multiple:!1,"show-upload-list":!1,accept:".xlsx,.xls,.csv","before-upload":t.handleDataUpload},{default:r(()=>[l("p",xe,[n(R,{type:"database",style:{"font-size":"48px",color:"#165dff"}})]),e[9]||(e[9]=l("p",{class:"ant-upload-text"},"点击或拖拽数据源文件到此处上传",-1)),e[10]||(e[10]=l("p",{class:"ant-upload-hint"},"支持 .xlsx, .xls, .csv 格式文件",-1))]),_:1},8,["before-upload"]),y.value?(v(),c("div",_e,[n(B,{color:"blue",style:{"margin-top":"16px"}},{default:r(()=>[p(m(y.value.name),1)]),_:1}),n(A,{type:"default",style:{"margin-left":"12px"},onClick:e[1]||(e[1]=d=>{y.value=null,s.value=null})},{default:r(()=>[...e[11]||(e[11]=[p(" 重新选择 ",-1)])]),_:1})])):b("",!0)])):b("",!0),o.value===3?(v(),c("div",he,[e[16]||(e[16]=l("h3",null,"字段映射设置",-1)),s.value&&s.value.columns?(v(),c("div",we,[n(w,{message:"模板占位符说明",description:"在模板文件中使用 {字段名} 作为占位符，系统会自动替换为数据源中的对应值",type:"info","show-icon":"",style:{"margin-bottom":"20px"}}),e[14]||(e[14]=l("h4",null,"数据源字段",-1)),n(h,{columns:O.value,"data-source":s.value.sampleData,pagination:!1,size:"small",style:{"margin-bottom":"20px"}},null,8,["columns","data-source"]),e[15]||(e[15]=l("h4",null,"映射设置",-1)),n(te,{layout:"vertical"},{default:r(()=>[n(S,{label:"输出文件名规则"},{default:r(()=>[n(k,{value:i.value.outputFilenameRule,"onUpdate:value":e[2]||(e[2]=d=>i.value.outputFilenameRule=d),placeholder:"例如：合同_{合同编号}.xlsx",style:{"max-width":"400px"}},null,8,["value"]),e[13]||(e[13]=l("div",{style:{"margin-top":"8px",color:"#666","font-size":"12px"}}," 使用 {字段名} 作为文件名中的变量 ",-1))]),_:1}),n(S,{label:"数据起始行"},{default:r(()=>[n(F,{value:i.value.dataStartRow,"onUpdate:value":e[3]||(e[3]=d=>i.value.dataStartRow=d),min:1,style:{width:"100px"}},null,8,["value"])]),_:1}),n(S,{label:"模板工作表"},{default:r(()=>[n(le,{value:i.value.templateSheet,"onUpdate:value":e[4]||(e[4]=d=>i.value.templateSheet=d),placeholder:"选择模板工作表",style:{width:"200px"}},{default:r(()=>[(v(!0),c(ie,null,de(C.value,d=>(v(),H(ee,{key:d,value:d},{default:r(()=>[p(m(d),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})])):(v(),c("div",be,[n(ae,{description:"请先上传数据源文件"})]))])):b("",!0),o.value===4?(v(),c("div",ke,[e[28]||(e[28]=l("h3",null,"生成设置",-1)),l("div",Fe,[e[25]||(e[25]=l("h4",null,"模板信息",-1)),l("p",null,[e[17]||(e[17]=l("strong",null,"模板文件：",-1)),p(m((z=g.value)==null?void 0:z.name),1)]),l("p",null,[e[18]||(e[18]=l("strong",null,"模板工作表：",-1)),p(m(i.value.templateSheet),1)]),e[26]||(e[26]=l("h4",null,"数据源信息",-1)),l("p",null,[e[19]||(e[19]=l("strong",null,"数据源文件：",-1)),p(m((N=y.value)==null?void 0:N.name),1)]),l("p",null,[e[20]||(e[20]=l("strong",null,"数据记录数：",-1)),p(m(((E=s.value)==null?void 0:E.totalRows)||0),1)]),l("p",null,[e[21]||(e[21]=l("strong",null,"数据字段数：",-1)),p(m(((V=(L=s.value)==null?void 0:L.columns)==null?void 0:V.length)||0),1)]),e[27]||(e[27]=l("h4",null,"生成设置",-1)),l("p",null,[e[22]||(e[22]=l("strong",null,"输出文件名规则：",-1)),p(m(i.value.outputFilenameRule),1)]),l("p",null,[e[23]||(e[23]=l("strong",null,"数据起始行：",-1)),p(m(i.value.dataStartRow),1)]),l("p",null,[e[24]||(e[24]=l("strong",null,"批量生成数量：",-1)),p(m(T.value)+" 个文件",1)]),n(A,{type:"primary",size:"large",onClick:P,disabled:U.value.value,style:{"margin-top":"20px"}},{default:r(()=>[p(m(U.value.value?"生成中...":"开始批量生成"),1)]),_:1},8,["disabled"])])])):b("",!0),x.value>0&&x.value<100?(v(),H(ne,{key:4,percent:x.value,style:{margin:"16px 0"}},null,8,["percent"])):b("",!0),a.value.length>0?(v(),c("div",Re,[e[29]||(e[29]=l("h3",null,"生成日志",-1)),n(oe,{bordered:"","data-source":a.value,size:"small"},{renderItem:r(({item:d})=>[n(se,null,{default:r(()=>[p(m(d),1)]),_:2},1024)]),_:1},8,["data-source"])])):b("",!0)])}}},$e=pe(Se,[["__scopeId","data-v-8a94c124"]]);export{$e as default};
