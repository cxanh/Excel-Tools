import{P as X,r as Y}from"./py-CjQq9lry.js";import{_ as Z,r as m,a as f,c as g,o as v,b as a,d as t,e as b,f as ee,w as p,g as r,t as d,F as te,i as le,n as N}from"./index-B5FopeIw.js";const se={class:"import-rules"},ne={style:{display:"none"}},ae={key:0,class:"step-content"},oe={class:"ant-upload-drag-icon"},ue={key:1,class:"step-content"},re={class:"rules-upload-section"},ie={class:"rules-upload"},pe={key:0,style:{padding:"24px","text-align":"center"}},de={key:1,style:{padding:"24px","text-align":"center"}},ce={key:2,class:"step-content"},ve={key:0,class:"rules-preview"},me={class:"rule-item"},ge={class:"rule-index"},fe={class:"rule-content"},ye={class:"settings-preview"},_e={key:1,class:"no-rules"},xe={key:3,class:"step-content"},he={class:"processing-summary"},ke={class:"settings-summary"},be={key:5,style:{margin:"16px 0"}},we={__name:"index",setup(Fe){const w=m(null),c=m(0),i=m([]),h=m(null),s=m(null),F=m(!1),x=m(0),o=m([]),I=m(null),z=m(null);m("all"),m("");const O=()=>{var e,n;return((e=s==null?void 0:s.settings)==null?void 0:e.rangeOption)==="custom"?`自定义范围：${s.settings.customRange}`:{all:"整个工作表",data:"仅数据区域",custom:"自定义范围"}[((n=s==null?void 0:s.settings)==null?void 0:n.rangeOption)||"all"]||"整个工作表"},A=async()=>(await fetch("/plugins/import-rules/worker.py")).text(),P=()=>{var l;(l=I.value)==null||l.click()},U=()=>{o.value.push("从文件夹导入功能开发中...")},B=l=>{switch(l){case"paste":o.value.push("从剪贴板读取功能开发中...");break;case"clear":i.value=[];break}},j=async()=>{if(c.value===0)c.value=1,o.value.push("进入上传Excel文件步骤...");else if(c.value===1){if(i.value.length===0){o.value.push("请先添加需要处理的Excel文件");return}c.value=2,o.value.push("进入上传规则文件步骤...")}else if(c.value===2){if(!s||!s.rules||s.rules.length===0){o.value.push("请先上传有效的规则文件");return}c.value=3,o.value.push("进入规则预览步骤...")}else c.value===3&&(c.value=4,await E())},V=l=>{i.value=i.value.filter(e=>e.key!==l)},J=l=>{const e=Array.from(l.target.files);e.length>0&&(e.forEach((n,y)=>{const _={key:`${n.name}-${Date.now()}-${y}`,index:i.value.length+y+1,name:n.name,path:n.name,extension:n.name.split(".").pop(),createTime:new Date(n.lastModified).toLocaleString(),modifyTime:new Date(n.lastModified).toLocaleString(),file:n};i.value.push(_)}),l.target.value="",N(()=>{w.value&&(w.value.files=i.value)}))},H=l=>{const e={key:`${l.name}-${Date.now()}`,index:i.value.length+1,name:l.name,path:l.name,extension:l.name.split(".").pop(),createTime:new Date(l.lastModified).toLocaleString(),modifyTime:new Date(l.lastModified).toLocaleString(),file:l};return i.value.push(e),N(()=>{w.value&&(w.value.files=i.value)}),!1},q=l=>{const e=l.target.files[0];e&&R(e),l.target.value=""},R=l=>{h.value=l;const e=new FileReader;return e.onload=n=>{try{const y=JSON.parse(n.target.result);s.value=y,o.value.push("规则文件解析成功")}catch(y){o.value.push(`规则文件解析错误: ${y.message}`),s.value=null,h.value=null}},e.readAsText(l),!1},E=async()=>{if(!(i.value.length===0||!s||!s.rules)){F.value=!0,o.value=["开始处理文件..."],x.value=10;try{const l=await A();x.value=30,o.value.push(`规则数量：${s.rules.length}`),o.value.push(`设置参数：${JSON.stringify(s.settings||{})}`);for(let e=0;e<i.value.length;e++){const n=i.value[e];o.value.push(`正在处理文件：${n.name}`);const y={file:n.file,replacementRules:s.rules,settings:s.settings||{}},_=await Y(l,y);x.value=30+Math.round((e+1)/i.value.length*50),o.value.push(`${n.name} 处理完成！`),o.value.push(..._.logs);const $=new Blob([_.buffer],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),T=URL.createObjectURL($),k=document.createElement("a");k.href=T,k.download=`${n.name.replace(".xlsx","").replace(".xls","")}_处理后.xlsx`,k.click(),URL.revokeObjectURL(T)}o.value.push("所有文件处理完成！"),x.value=100}catch(l){o.value.push(`错误：${l.message}`),console.error("Processing error:",l)}finally{F.value=!1}}};return(l,e)=>{var D,L,M;const n=f("a-icon"),y=f("a-upload-dragger"),_=f("a-button"),$=f("a-tag"),T=f("a-upload"),k=f("a-list-item"),C=f("a-list"),S=f("a-descriptions-item"),G=f("a-descriptions"),K=f("a-empty"),Q=f("a-progress");return v(),g("div",se,[a(X,{"plugin-title":"导入规则修改内容","info-message":"当不同的 Excel 文档有不同的修改规则时，可以通过导入规则文件进行批量修改","current-step":c.value,onAddFile:P,onImportFolder:U,onMoreAction:B,onNextStep:j,onRemoveFile:V,ref_key:"pluginTemplate",ref:w},null,8,["current-step"]),t("div",ne,[t("input",{ref_key:"fileInput",ref:I,type:"file",accept:".xlsx,.xls",multiple:"",onChange:J},null,544),t("input",{ref_key:"rulesInput",ref:z,type:"file",accept:".json",onChange:q},null,544)]),c.value===1?(v(),g("div",ae,[e[3]||(e[3]=t("h3",null,"上传Excel文件",-1)),a(y,{name:"file",multiple:!0,"show-upload-list":!1,accept:".xlsx,.xls","before-upload":H},{default:p(()=>[t("p",oe,[a(n,{type:"inbox",style:{"font-size":"48px",color:"#165dff"}})]),e[1]||(e[1]=t("p",{class:"ant-upload-text"},"点击或拖拽文件到此处上传",-1)),e[2]||(e[2]=t("p",{class:"ant-upload-hint"},"支持上传多个Excel文件",-1))]),_:1})])):b("",!0),c.value===2?(v(),g("div",ue,[e[9]||(e[9]=t("h3",null,"上传规则文件",-1)),t("div",re,[a(T,{"show-upload-list":!1,"before-upload":R,accept:".json"},{default:p(()=>[t("div",ie,[h.value?(v(),g("div",de,[a(n,{type:"check-circle",style:{"font-size":"48px",color:"#52c41a"}}),e[8]||(e[8]=t("p",{style:{margin:"16px 0"}},"规则文件已上传",-1)),a($,{color:"green"},{default:p(()=>[r(d(h.value.name),1)]),_:1}),a(_,{type:"default",style:{"margin-left":"12px"},onClick:e[0]||(e[0]=u=>{h.value=null,s.value=null})},{default:p(()=>[...e[7]||(e[7]=[r(" 重新选择 ",-1)])]),_:1})])):(v(),g("div",pe,[a(n,{type:"file-text",style:{"font-size":"48px",color:"#165dff"}}),e[5]||(e[5]=t("p",{style:{margin:"16px 0"}},"点击上传规则文件",-1)),a(_,{type:"primary"},{default:p(()=>[...e[4]||(e[4]=[r("选择JSON文件",-1)])]),_:1}),e[6]||(e[6]=t("p",{style:{margin:"16px 0",color:"#999","font-size":"12px"}},[r(" 规则文件格式示例： "),t("pre",{style:{background:"#f5f5f5",padding:"8px","text-align":"left","font-size":"11px","overflow-x":"auto"}},`{
  "rules": [
    {
      "findText": "旧内容",
      "replaceText": "新内容",
      "matchMode": "normal"
    }
  ],
  "settings": {
    "caseSensitive": false,
    "matchEntireCell": false
  }
}
                `)],-1))]))])]),_:1})])])):b("",!0),c.value===3?(v(),g("div",ce,[e[15]||(e[15]=t("h3",null,"规则预览",-1)),s.value&&s.value.rules?(v(),g("div",ve,[e[13]||(e[13]=t("h4",null,"替换规则",-1)),a(C,{"data-source":s.value.rules,bordered:"",size:"small",style:{"margin-bottom":"20px"}},{renderItem:p(({item:u,index:W})=>[a(k,null,{default:p(()=>[t("div",me,[t("div",ge,d(W+1),1),t("div",fe,[t("p",null,[e[10]||(e[10]=t("strong",null,"查找:",-1)),r(' "'+d(u.findText)+'"',1)]),t("p",null,[e[11]||(e[11]=t("strong",null,"替换为:",-1)),r(' "'+d(u.replaceText||"（删除）")+'"',1)]),t("p",null,[e[12]||(e[12]=t("strong",null,"匹配模式:",-1)),r(" "+d(u.matchMode==="regex"?"正则表达式":"普通文本"),1)])])])]),_:2},1024)]),_:1},8,["data-source"]),e[14]||(e[14]=t("h4",null,"高级设置",-1)),t("div",ye,[a(G,{bordered:"",column:"2"},{default:p(()=>[a(S,{label:"区分大小写"},{default:p(()=>{var u;return[r(d((u=s.value.settings)!=null&&u.caseSensitive?"是":"否"),1)]}),_:1}),a(S,{label:"匹配整个单元格"},{default:p(()=>{var u;return[r(d((u=s.value.settings)!=null&&u.matchEntireCell?"是":"否"),1)]}),_:1}),a(S,{label:"忽略隐藏单元格"},{default:p(()=>{var u;return[r(d((u=s.value.settings)!=null&&u.ignoreHiddenCells?"是":"否"),1)]}),_:1}),a(S,{label:"处理范围"},{default:p(()=>[r(d(O()),1)]),_:1})]),_:1})])])):(v(),g("div",_e,[a(K,{description:"未加载规则内容"})]))])):b("",!0),c.value===4?(v(),g("div",xe,[e[21]||(e[21]=t("h3",null,"处理确认",-1)),t("div",he,[t("p",null,[e[16]||(e[16]=r(" 即将处理 ",-1)),t("strong",null,d(i.value.value.length),1),e[17]||(e[17]=r(" 个文件： ",-1))]),t("ul",null,[(v(!0),g(te,null,le(i.value.value,u=>(v(),g("li",{key:u.key},d(u.name),1))),128))]),t("div",ke,[e[20]||(e[20]=t("h4",null,"处理设置：",-1)),t("p",null,[e[18]||(e[18]=t("strong",null,"替换规则数量：",-1)),r(d(((L=(D=s.value)==null?void 0:D.rules)==null?void 0:L.length)||0),1)]),t("p",null,[e[19]||(e[19]=t("strong",null,"规则文件：",-1)),r(d(((M=h.value)==null?void 0:M.name)||"未选择"),1)])]),a(_,{type:"primary",size:"large",onClick:E,disabled:F.value.value},{default:p(()=>[r(d(F.value.value?"处理中...":"开始处理"),1)]),_:1},8,["disabled"])])])):b("",!0),x.value>0&&x.value<100?(v(),ee(Q,{key:4,percent:x.value,style:{margin:"16px 0"}},null,8,["percent"])):b("",!0),o.value.length>0?(v(),g("div",be,[e[22]||(e[22]=t("h3",null,"处理日志",-1)),a(C,{bordered:"","data-source":o.value,size:"small"},{renderItem:p(({item:u})=>[a(k,null,{default:p(()=>[r(d(u),1)]),_:2},1024)]),_:1},8,["data-source"])])):b("",!0)])}}},$e=Z(we,[["__scopeId","data-v-9c0eea32"]]);export{$e as default};
