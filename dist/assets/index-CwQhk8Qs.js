import{P as oe,r as re}from"./py-CjQq9lry.js";import{_ as pe,r as f,h as M,a as o,c,o as d,b as n,d as l,e as b,f as O,w as r,g as p,t as m,F as ie,i as ve}from"./index-B5FopeIw.js";const de={class:"generate-from-template"},me={style:{display:"none"}},fe={key:0,class:"step-content"},ce={class:"ant-upload-drag-icon"},ge={key:0,class:"file-info"},ye={key:1,class:"step-content"},xe={class:"ant-upload-drag-icon"},_e={key:0,class:"file-info"},he={key:2,class:"step-content"},we={key:0,class:"mapping-section"},be={key:1,class:"no-data"},ke={key:3,class:"step-content"},Fe={class:"processing-summary"},Re={key:5,style:{margin:"16px 0"}},Se={__name:"index",setup(Ae){const j=f(null),u=f(0),g=f(null),y=f(null),s=f(null),U=f([]),$=f(!1),_=f(0),a=f([]),T=f(null),P=f(null),i=f({outputFilenameRule:"文档_{序号}.xlsx",dataStartRow:1,templateSheet:""}),I=M(()=>Math.min((s==null?void 0:s.totalRows)||0,100)),J=M(()=>s!=null&&s.columns?s.columns.map(t=>({title:t,dataIndex:t,key:t})):[]),q=async()=>(await fetch("/plugins/generate-from-template/worker.py")).text(),G=()=>{var t,e;u.value===1?(t=T.value)==null||t.click():u.value===2&&((e=P.value)==null||e.click())},K=()=>{a.value.push("从文件夹导入功能开发中...")},Q=t=>{switch(t){case"paste":a.value.push("从剪贴板读取功能开发中...");break;case"clear":u.value===1?g.value=null:u.value===2&&(y.value=null,s.value=null);break}},W=async()=>{if(u.value===0)u.value=1,a.value.push("进入上传模板文件步骤...");else if(u.value===1){if(!g.value){a.value.push("请先上传模板文件");return}u.value=2,a.value.push("进入上传数据源步骤...")}else if(u.value===2){if(!y.value||!s.value){a.value.push("请先上传数据源文件");return}u.value=3,a.value.push("进入字段映射步骤...")}else if(u.value===3){if(!i.value.outputFilenameRule){a.value.push("请设置输出文件名规则");return}u.value=4,a.value.push("进入开始生成步骤...")}else u.value===4&&await D()},X=t=>{},Y=t=>{const e=t.target.files[0];e&&z(e),t.target.value=""},z=t=>{g.value=t;const e=new FileReader;return e.onload=F=>{try{U.value=["Sheet1","Sheet2","Sheet3"],i.value.templateSheet=U.value[0],a.value.push("模板文件解析成功")}catch(h){a.value.push(`模板文件解析错误: ${h.message}`),U.value=[]}},e.readAsArrayBuffer(t),!1},Z=t=>{const e=t.target.files[0];e&&ee(e),t.target.value=""},ee=t=>{y.value=t;const e=new FileReader;return e.onload=F=>{try{s.value={columns:["合同编号","客户名称","金额","日期","状态"],sampleData:[{合同编号:"HT001",客户名称:"客户A",金额:1e4,日期:"2026-01-14",状态:"生效"},{合同编号:"HT002",客户名称:"客户B",金额:2e4,日期:"2026-01-15",状态:"生效"},{合同编号:"HT003",客户名称:"客户C",金额:3e4,日期:"2026-01-16",状态:"草稿"}],totalRows:50},a.value.push("数据源文件解析成功")}catch(h){a.value.push(`数据源文件解析错误: ${h.message}`),s.value=null}},e.readAsArrayBuffer(t),!1},D=async()=>{if(!(!g.value||!y.value||!s.value)){$.value=!0,a.value=["开始批量生成文档..."],_.value=10;try{const t=await q();_.value=30,a.value.push(`模板文件: ${g.value.name}`),a.value.push(`数据源文件: ${y.value.name}`),a.value.push(`生成数量: ${I.value} 个文件`),a.value.push(`设置参数: ${JSON.stringify(i.value)}`);const e=new FileReader,F=await new Promise(x=>{e.onload=k=>x(k.target.result),e.readAsArrayBuffer(g.value)});_.value=40;const h=new FileReader,B=await new Promise(x=>{h.onload=k=>x(k.target.result),h.readAsArrayBuffer(y.value)});_.value=50;const A={template:new Uint8Array(F),data:new Uint8Array(B),settings:i.value,dataInfo:s.value};a.value.push("开始批量生成...");const R=await re(t,A);if(_.value=80,R.success){a.value.push("文档批量生成完成！"),a.value.push(...R.logs);for(let x=0;x<I.value;x++){const k=new Blob([R.buffer],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),S=URL.createObjectURL(k),C=document.createElement("a");C.href=S;let w=i.value.outputFilenameRule;w=w.replace("{序号}",x+1),w=w.replace("{合同编号}",`HT${(1e3+x).toString().slice(-3)}`),C.download=w,a.value.push(`生成文件: ${w}`),URL.revokeObjectURL(S)}}else a.value.push(`生成失败: ${R.error}`);_.value=100}catch(t){a.value.push(`错误: ${t.message}`),console.error("Processing error:",t)}finally{$.value=!1}}};return(t,e)=>{var N,E,L,H,V;const F=o("a-icon"),h=o("a-upload-dragger"),B=o("a-tag"),A=o("a-button"),R=o("a-alert"),x=o("a-table"),k=o("a-input"),S=o("a-form-item"),C=o("a-input-number"),w=o("a-select-option"),le=o("a-select"),te=o("a-form"),ae=o("a-empty"),ne=o("a-progress"),se=o("a-list-item"),ue=o("a-list");return d(),c("div",de,[n(oe,{"plugin-title":"根据模板生成文档","info-message":"先指定一个 Excel 文档作为模板，然后根据数据源批量生成多个 Excel 文档","current-step":u.value,onAddFile:G,onImportFolder:K,onMoreAction:Q,onNextStep:W,onRemoveFile:X,ref_key:"pluginTemplate",ref:j},null,8,["current-step"]),l("div",me,[l("input",{ref_key:"templateInput",ref:T,type:"file",accept:".xlsx,.xls",onChange:Y},null,544),l("input",{ref_key:"dataInput",ref:P,type:"file",accept:".xlsx,.xls,.csv",onChange:Z},null,544)]),u.value===1?(d(),c("div",fe,[e[8]||(e[8]=l("h3",null,"上传Excel模板",-1)),n(h,{name:"file",multiple:!1,"show-upload-list":!1,accept:".xlsx,.xls","before-upload":z},{default:r(()=>[l("p",ce,[n(F,{type:"file-excel",style:{"font-size":"48px",color:"#52c41a"}})]),e[5]||(e[5]=l("p",{class:"ant-upload-text"},"点击或拖拽模板文件到此处上传",-1)),e[6]||(e[6]=l("p",{class:"ant-upload-hint"},"支持 .xlsx, .xls 格式文件",-1))]),_:1}),g.value?(d(),c("div",ge,[n(B,{color:"green",style:{"margin-top":"16px"}},{default:r(()=>[p(m(g.value.name),1)]),_:1}),n(A,{type:"default",style:{"margin-left":"12px"},onClick:e[0]||(e[0]=v=>g.value=null)},{default:r(()=>[...e[7]||(e[7]=[p(" 重新选择 ",-1)])]),_:1})])):b("",!0)])):b("",!0),u.value===2?(d(),c("div",ye,[e[12]||(e[12]=l("h3",null,"上传数据源",-1)),n(h,{name:"file",multiple:!1,"show-upload-list":!1,accept:".xlsx,.xls,.csv","before-upload":t.handleDataUpload},{default:r(()=>[l("p",xe,[n(F,{type:"database",style:{"font-size":"48px",color:"#165dff"}})]),e[9]||(e[9]=l("p",{class:"ant-upload-text"},"点击或拖拽数据源文件到此处上传",-1)),e[10]||(e[10]=l("p",{class:"ant-upload-hint"},"支持 .xlsx, .xls, .csv 格式文件",-1))]),_:1},8,["before-upload"]),y.value?(d(),c("div",_e,[n(B,{color:"blue",style:{"margin-top":"16px"}},{default:r(()=>[p(m(y.value.name),1)]),_:1}),n(A,{type:"default",style:{"margin-left":"12px"},onClick:e[1]||(e[1]=v=>{y.value=null,s.value=null})},{default:r(()=>[...e[11]||(e[11]=[p(" 重新选择 ",-1)])]),_:1})])):b("",!0)])):b("",!0),u.value===3?(d(),c("div",he,[e[16]||(e[16]=l("h3",null,"字段映射设置",-1)),s.value&&s.value.columns?(d(),c("div",we,[n(R,{message:"模板占位符说明",description:"在模板文件中使用 {字段名} 作为占位符，系统会自动替换为数据源中的对应值",type:"info","show-icon":"",style:{"margin-bottom":"20px"}}),e[14]||(e[14]=l("h4",null,"数据源字段",-1)),n(x,{columns:J.value,"data-source":s.value.sampleData,pagination:!1,size:"small",style:{"margin-bottom":"20px"}},null,8,["columns","data-source"]),e[15]||(e[15]=l("h4",null,"映射设置",-1)),n(te,{layout:"vertical"},{default:r(()=>[n(S,{label:"输出文件名规则"},{default:r(()=>[n(k,{value:i.value.outputFilenameRule,"onUpdate:value":e[2]||(e[2]=v=>i.value.outputFilenameRule=v),placeholder:"例如：合同_{合同编号}.xlsx",style:{"max-width":"400px"}},null,8,["value"]),e[13]||(e[13]=l("div",{style:{"margin-top":"8px",color:"#666","font-size":"12px"}}," 使用 {字段名} 作为文件名中的变量 ",-1))]),_:1}),n(S,{label:"数据起始行"},{default:r(()=>[n(C,{value:i.value.dataStartRow,"onUpdate:value":e[3]||(e[3]=v=>i.value.dataStartRow=v),min:1,style:{width:"100px"}},null,8,["value"])]),_:1}),n(S,{label:"模板工作表"},{default:r(()=>[n(le,{value:i.value.templateSheet,"onUpdate:value":e[4]||(e[4]=v=>i.value.templateSheet=v),placeholder:"选择模板工作表",style:{width:"200px"}},{default:r(()=>[(d(!0),c(ie,null,ve(U.value,v=>(d(),O(w,{key:v,value:v},{default:r(()=>[p(m(v),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})])):(d(),c("div",be,[n(ae,{description:"请先上传数据源文件"})]))])):b("",!0),u.value===4?(d(),c("div",ke,[e[28]||(e[28]=l("h3",null,"生成设置",-1)),l("div",Fe,[e[25]||(e[25]=l("h4",null,"模板信息",-1)),l("p",null,[e[17]||(e[17]=l("strong",null,"模板文件：",-1)),p(m((N=g.value)==null?void 0:N.name),1)]),l("p",null,[e[18]||(e[18]=l("strong",null,"模板工作表：",-1)),p(m(i.value.templateSheet),1)]),e[26]||(e[26]=l("h4",null,"数据源信息",-1)),l("p",null,[e[19]||(e[19]=l("strong",null,"数据源文件：",-1)),p(m((E=y.value)==null?void 0:E.name),1)]),l("p",null,[e[20]||(e[20]=l("strong",null,"数据记录数：",-1)),p(m(((L=s.value)==null?void 0:L.totalRows)||0),1)]),l("p",null,[e[21]||(e[21]=l("strong",null,"数据字段数：",-1)),p(m(((V=(H=s.value)==null?void 0:H.columns)==null?void 0:V.length)||0),1)]),e[27]||(e[27]=l("h4",null,"生成设置",-1)),l("p",null,[e[22]||(e[22]=l("strong",null,"输出文件名规则：",-1)),p(m(i.value.outputFilenameRule),1)]),l("p",null,[e[23]||(e[23]=l("strong",null,"数据起始行：",-1)),p(m(i.value.dataStartRow),1)]),l("p",null,[e[24]||(e[24]=l("strong",null,"批量生成数量：",-1)),p(m(I.value)+" 个文件",1)]),n(A,{type:"primary",size:"large",onClick:D,disabled:$.value.value,style:{"margin-top":"20px"}},{default:r(()=>[p(m($.value.value?"生成中...":"开始批量生成"),1)]),_:1},8,["disabled"])])])):b("",!0),_.value>0&&_.value<100?(d(),O(ne,{key:4,percent:_.value,style:{margin:"16px 0"}},null,8,["percent"])):b("",!0),a.value.length>0?(d(),c("div",Re,[e[29]||(e[29]=l("h3",null,"生成日志",-1)),n(ue,{bordered:"","data-source":a.value,size:"small"},{renderItem:r(({item:v})=>[n(se,null,{default:r(()=>[p(m(v),1)]),_:2},1024)]),_:1},8,["data-source"])])):b("",!0)])}}},Be=pe(Se,[["__scopeId","data-v-87d1f65a"]]);export{Be as default};
