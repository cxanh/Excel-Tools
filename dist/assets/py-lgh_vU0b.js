import{B as k}from"./index-tMO3H4K7.js";var ce=Object.create,N=Object.defineProperty,de=Object.getOwnPropertyDescriptor,ue=Object.getOwnPropertyNames,fe=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty,h=(e,r)=>N(e,"name",{value:r,configurable:!0}),me=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(r,a)=>(typeof require<"u"?require:r)[a]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+e+'" is not supported')}),T=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports),he=(e,r,a,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of ue(r))!pe.call(e,n)&&n!==a&&N(e,n,{get:()=>r[n],enumerable:!(t=de(r,n))||t.enumerable});return e},ye=(e,r,a)=>(a=e!=null?ce(fe(e)):{},he(!e||!e.__esModule?N(a,"default",{value:e,enumerable:!0}):a,e)),ge=T((e,r)=>{(function(a,t){typeof define=="function"&&define.amd?define("stackframe",[],t):typeof e=="object"?r.exports=t():a.StackFrame=t()})(e,function(){function a(f){return!isNaN(parseFloat(f))&&isFinite(f)}h(a,"_isNumber");function t(f){return f.charAt(0).toUpperCase()+f.substring(1)}h(t,"_capitalize");function n(f){return function(){return this[f]}}h(n,"_getter");var o=["isConstructor","isEval","isNative","isToplevel"],i=["columnNumber","lineNumber"],d=["fileName","functionName","source"],s=["args"],u=["evalOrigin"],c=o.concat(i,d,s,u);function l(f){if(f)for(var g=0;g<c.length;g++)f[c[g]]!==void 0&&this["set"+t(c[g])](f[c[g]])}h(l,"StackFrame"),l.prototype={getArgs:function(){return this.args},setArgs:function(f){if(Object.prototype.toString.call(f)!=="[object Array]")throw new TypeError("Args must be an Array");this.args=f},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(f){if(f instanceof l)this.evalOrigin=f;else if(f instanceof Object)this.evalOrigin=new l(f);else throw new TypeError("Eval Origin must be an Object or StackFrame")},toString:function(){var f=this.getFileName()||"",g=this.getLineNumber()||"",w=this.getColumnNumber()||"",v=this.getFunctionName()||"";return this.getIsEval()?f?"[eval] ("+f+":"+g+":"+w+")":"[eval]:"+g+":"+w:v?v+" ("+f+":"+g+":"+w+")":f+":"+g+":"+w}},l.fromString=h(function(f){var g=f.indexOf("("),w=f.lastIndexOf(")"),v=f.substring(0,g),oe=f.substring(g+1,w).split(","),D=f.substring(w+1);if(D.indexOf("@")===0)var R=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(D,""),ne=R[1],se=R[2],le=R[3];return new l({functionName:v,args:oe||void 0,fileName:ne,lineNumber:se||void 0,columnNumber:le||void 0})},"StackFrame$$fromString");for(var p=0;p<o.length;p++)l.prototype["get"+t(o[p])]=n(o[p]),l.prototype["set"+t(o[p])]=function(f){return function(g){this[f]=!!g}}(o[p]);for(var m=0;m<i.length;m++)l.prototype["get"+t(i[m])]=n(i[m]),l.prototype["set"+t(i[m])]=function(f){return function(g){if(!a(g))throw new TypeError(f+" must be a Number");this[f]=Number(g)}}(i[m]);for(var y=0;y<d.length;y++)l.prototype["get"+t(d[y])]=n(d[y]),l.prototype["set"+t(d[y])]=function(f){return function(g){this[f]=String(g)}}(d[y]);return l})}),be=T((e,r)=>{(function(a,t){typeof define=="function"&&define.amd?define("error-stack-parser",["stackframe"],t):typeof e=="object"?r.exports=t(ge()):a.ErrorStackParser=t(a.StackFrame)})(e,h(function(a){var t=/(^|@)\S+:\d+/,n=/^\s*at .*(\S+:\d+|\(native\))/m,o=/^(eval@)?(\[native code])?$/;return{parse:h(function(i){if(typeof i.stacktrace<"u"||typeof i["opera#sourceloc"]<"u")return this.parseOpera(i);if(i.stack&&i.stack.match(n))return this.parseV8OrIE(i);if(i.stack)return this.parseFFOrSafari(i);throw new Error("Cannot parse given Error object")},"ErrorStackParser$$parse"),extractLocation:h(function(i){if(i.indexOf(":")===-1)return[i];var d=/(.+?)(?::(\d+))?(?::(\d+))?$/,s=d.exec(i.replace(/[()]/g,""));return[s[1],s[2]||void 0,s[3]||void 0]},"ErrorStackParser$$extractLocation"),parseV8OrIE:h(function(i){var d=i.stack.split(`
`).filter(function(s){return!!s.match(n)},this);return d.map(function(s){s.indexOf("(eval ")>-1&&(s=s.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var u=s.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),c=u.match(/ (\(.+\)$)/);u=c?u.replace(c[0],""):u;var l=this.extractLocation(c?c[1]:u),p=c&&u||void 0,m=["eval","<anonymous>"].indexOf(l[0])>-1?void 0:l[0];return new a({functionName:p,fileName:m,lineNumber:l[1],columnNumber:l[2],source:s})},this)},"ErrorStackParser$$parseV8OrIE"),parseFFOrSafari:h(function(i){var d=i.stack.split(`
`).filter(function(s){return!s.match(o)},this);return d.map(function(s){if(s.indexOf(" > eval")>-1&&(s=s.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),s.indexOf("@")===-1&&s.indexOf(":")===-1)return new a({functionName:s});var u=/((.*".+"[^@]*)?[^@]*)(?:@)/,c=s.match(u),l=c&&c[1]?c[1]:void 0,p=this.extractLocation(s.replace(u,""));return new a({functionName:l,fileName:p[0],lineNumber:p[1],columnNumber:p[2],source:s})},this)},"ErrorStackParser$$parseFFOrSafari"),parseOpera:h(function(i){return!i.stacktrace||i.message.indexOf(`
`)>-1&&i.message.split(`
`).length>i.stacktrace.split(`
`).length?this.parseOpera9(i):i.stack?this.parseOpera11(i):this.parseOpera10(i)},"ErrorStackParser$$parseOpera"),parseOpera9:h(function(i){for(var d=/Line (\d+).*script (?:in )?(\S+)/i,s=i.message.split(`
`),u=[],c=2,l=s.length;c<l;c+=2){var p=d.exec(s[c]);p&&u.push(new a({fileName:p[2],lineNumber:p[1],source:s[c]}))}return u},"ErrorStackParser$$parseOpera9"),parseOpera10:h(function(i){for(var d=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,s=i.stacktrace.split(`
`),u=[],c=0,l=s.length;c<l;c+=2){var p=d.exec(s[c]);p&&u.push(new a({functionName:p[3]||void 0,fileName:p[2],lineNumber:p[1],source:s[c]}))}return u},"ErrorStackParser$$parseOpera10"),parseOpera11:h(function(i){var d=i.stack.split(`
`).filter(function(s){return!!s.match(t)&&!s.match(/^Error created at/)},this);return d.map(function(s){var u=s.split("@"),c=this.extractLocation(u.pop()),l=u.shift()||"",p=l.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0,m;l.match(/\(([^)]*)\)/)&&(m=l.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var y=m===void 0||m==="[arguments not available]"?void 0:m.split(",");return new a({functionName:p,args:y,fileName:c[0],lineNumber:c[1],columnNumber:c[2],source:s})},this)},"ErrorStackParser$$parseOpera11")}},"ErrorStackParser"))}),_e=ye(be()),E=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&typeof process.browser>"u",C,O,x,M,U;async function H(){if(!E||(C=(await k(async()=>{const{default:o}=await import("./__vite-browser-external-BIHI7g3E.js");return{default:o}},[])).default,U=await k(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]),globalThis.fetch?O=fetch:O=(await k(async()=>{const{default:o}=await import("node-fetch");return{default:o}},[])).default,M=(await k(async()=>{const{default:o}=await import("vm");return{default:o}},[])).default,x=await k(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]),I=x.sep,typeof me<"u"))return;let e=await k(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]),r=await k(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]),a=await k(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]),t=await k(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]),n={fs:e,crypto:r,ws:a,child_process:t};globalThis.require=function(o){return n[o]}}h(H,"initNodeModules");function V(e,r){return x.resolve(r||".",e)}h(V,"node_resolvePath");function W(e,r){return r===void 0&&(r=location),new URL(e,r).toString()}h(W,"browser_resolvePath");var F;E?F=V:F=W;var I;E||(I="/");function q(e,r){return e.startsWith("file://")&&(e=e.slice(7)),e.includes("://")?{response:O(e)}:{binary:U.readFile(e).then(a=>new Uint8Array(a.buffer,a.byteOffset,a.byteLength))}}h(q,"node_getBinaryResponse");function z(e,r){let a=new URL(e,location);return{response:fetch(a,r?{integrity:r}:{})}}h(z,"browser_getBinaryResponse");var $;E?$=q:$=z;async function B(e,r){let{response:a,binary:t}=$(e,r);if(t)return t;let n=await a;if(!n.ok)throw new Error(`Failed to load '${e}': request failed.`);return new Uint8Array(await n.arrayBuffer())}h(B,"loadBinaryFile");var L;if(globalThis.document)L=h(async e=>await import(e),"loadScript");else if(globalThis.importScripts)L=h(async e=>{try{globalThis.importScripts(e)}catch(r){if(r instanceof TypeError)await import(e);else throw r}},"loadScript");else if(E)L=G;else throw new Error("Cannot determine runtime environment");async function G(e){e.startsWith("file://")&&(e=e.slice(7)),e.includes("://")?M.runInThisContext(await(await O(e)).text()):await import(C.pathToFileURL(e).href)}h(G,"nodeLoadScript");function J(e){let r=e.FS,a=e.FS.filesystems.MEMFS,t=e.PATH,n={DIR_MODE:16895,FILE_MODE:33279,mount:function(o){if(!o.opts.fileSystemHandle)throw new Error("opts.fileSystemHandle is required");return a.mount.apply(null,arguments)},syncfs:async(o,i,d)=>{try{let s=n.getLocalSet(o),u=await n.getRemoteSet(o),c=i?u:s,l=i?s:u;await n.reconcile(o,c,l),d(null)}catch(s){d(s)}},getLocalSet:o=>{let i=Object.create(null);function d(c){return c!=="."&&c!==".."}h(d,"isRealDir");function s(c){return l=>t.join2(c,l)}h(s,"toAbsolute");let u=r.readdir(o.mountpoint).filter(d).map(s(o.mountpoint));for(;u.length;){let c=u.pop(),l=r.stat(c);r.isDir(l.mode)&&u.push.apply(u,r.readdir(c).filter(d).map(s(c))),i[c]={timestamp:l.mtime,mode:l.mode}}return{type:"local",entries:i}},getRemoteSet:async o=>{let i=Object.create(null),d=await we(o.opts.fileSystemHandle);for(let[s,u]of d)s!=="."&&(i[t.join2(o.mountpoint,s)]={timestamp:u.kind==="file"?(await u.getFile()).lastModifiedDate:new Date,mode:u.kind==="file"?n.FILE_MODE:n.DIR_MODE});return{type:"remote",entries:i,handles:d}},loadLocalEntry:o=>{let i=r.lookupPath(o).node,d=r.stat(o);if(r.isDir(d.mode))return{timestamp:d.mtime,mode:d.mode};if(r.isFile(d.mode))return i.contents=a.getFileDataAsTypedArray(i),{timestamp:d.mtime,mode:d.mode,contents:i.contents};throw new Error("node type not supported")},storeLocalEntry:(o,i)=>{if(r.isDir(i.mode))r.mkdirTree(o,i.mode);else if(r.isFile(i.mode))r.writeFile(o,i.contents,{canOwn:!0});else throw new Error("node type not supported");r.chmod(o,i.mode),r.utime(o,i.timestamp,i.timestamp)},removeLocalEntry:o=>{var i=r.stat(o);r.isDir(i.mode)?r.rmdir(o):r.isFile(i.mode)&&r.unlink(o)},loadRemoteEntry:async o=>{if(o.kind==="file"){let i=await o.getFile();return{contents:new Uint8Array(await i.arrayBuffer()),mode:n.FILE_MODE,timestamp:i.lastModifiedDate}}else{if(o.kind==="directory")return{mode:n.DIR_MODE,timestamp:new Date};throw new Error("unknown kind: "+o.kind)}},storeRemoteEntry:async(o,i,d)=>{let s=o.get(t.dirname(i)),u=r.isFile(d.mode)?await s.getFileHandle(t.basename(i),{create:!0}):await s.getDirectoryHandle(t.basename(i),{create:!0});if(u.kind==="file"){let c=await u.createWritable();await c.write(d.contents),await c.close()}o.set(i,u)},removeRemoteEntry:async(o,i)=>{await o.get(t.dirname(i)).removeEntry(t.basename(i)),o.delete(i)},reconcile:async(o,i,d)=>{let s=0,u=[];Object.keys(i.entries).forEach(function(p){let m=i.entries[p],y=d.entries[p];(!y||r.isFile(m.mode)&&m.timestamp.getTime()>y.timestamp.getTime())&&(u.push(p),s++)}),u.sort();let c=[];if(Object.keys(d.entries).forEach(function(p){i.entries[p]||(c.push(p),s++)}),c.sort().reverse(),!s)return;let l=i.type==="remote"?i.handles:d.handles;for(let p of u){let m=t.normalize(p.replace(o.mountpoint,"/")).substring(1);if(d.type==="local"){let y=l.get(m),f=await n.loadRemoteEntry(y);n.storeLocalEntry(p,f)}else{let y=n.loadLocalEntry(p);await n.storeRemoteEntry(l,m,y)}}for(let p of c)if(d.type==="local")n.removeLocalEntry(p);else{let m=t.normalize(p.replace(o.mountpoint,"/")).substring(1);await n.removeRemoteEntry(l,m)}}};e.FS.filesystems.NATIVEFS_ASYNC=n}h(J,"initializeNativeFS");var we=h(async e=>{let r=[];async function a(n){for await(let o of n.values())r.push(o),o.kind==="directory"&&await a(o)}h(a,"collect"),await a(e);let t=new Map;t.set(".",e);for(let n of r){let o=(await e.resolve(n)).join("/");t.set(o,n)}return t},"getFsHandles");function K(){let e={};return e.noImageDecoding=!0,e.noAudioDecoding=!0,e.noWasmDecoding=!1,e.preRun=[],e.quit=(r,a)=>{throw e.exited={status:r,toThrow:a},a},e}h(K,"createModule");function Y(e,r){e.preRun.push(function(){let a="/";try{e.FS.mkdirTree(r)}catch(t){console.error(`Error occurred while making a home directory '${r}':`),console.error(t),console.error(`Using '${a}' for a home directory instead`),r=a}e.FS.chdir(r)})}h(Y,"createHomeDirectory");function Q(e,r){e.preRun.push(function(){Object.assign(e.ENV,r)})}h(Q,"setEnvironment");function X(e,r){e.preRun.push(()=>{for(let a of r)e.FS.mkdirTree(a),e.FS.mount(e.FS.filesystems.NODEFS,{root:a},a)})}h(X,"mountLocalDirectories");function Z(e,r){let a=B(r);e.preRun.push(()=>{let t=e._py_version_major(),n=e._py_version_minor();e.FS.mkdirTree("/lib"),e.FS.mkdirTree(`/lib/python${t}.${n}/site-packages`),e.addRunDependency("install-stdlib"),a.then(o=>{e.FS.writeFile(`/lib/python${t}${n}.zip`,o)}).catch(o=>{console.error("Error occurred while installing the standard library:"),console.error(o)}).finally(()=>{e.removeRunDependency("install-stdlib")})})}h(Z,"installStdlib");function ee(e,r){let a;r.stdLibURL!=null?a=r.stdLibURL:a=r.indexURL+"python_stdlib.zip",Z(e,a),Y(e,r.env.HOME),Q(e,r.env),X(e,r._node_mounts),e.preRun.push(()=>J(e))}h(ee,"initializeFileSystem");function te(e,r){let{binary:a,response:t}=$(r+"pyodide.asm.wasm");e.instantiateWasm=function(n,o){return async function(){try{let i;t?i=await WebAssembly.instantiateStreaming(t,n):i=await WebAssembly.instantiate(await a,n);let{instance:d,module:s}=i;typeof WasmOffsetConverter<"u"&&(wasmOffsetConverter=new WasmOffsetConverter(wasmBinary,s)),o(d,s)}catch(i){console.warn("wasm instantiation failed!"),console.warn(i)}}(),{}}}h(te,"preloadWasm");var S="0.24.1";function re(e,r){return new Proxy(e,{get(a,t){return t==="get"?n=>{let o=a.get(n);return o===void 0&&(o=r.get(n)),o}:t==="has"?n=>a.has(n)||r.has(n):Reflect.get(a,t)}})}h(re,"wrapPythonGlobals");function ie(e,r){e.runPythonInternal_dict=e._pyodide._base.eval_code("{}"),e.importlib=e.runPythonInternal("import importlib; importlib");let a=e.importlib.import_module;e.sys=a("sys"),e.sys.path.insert(0,r.env.HOME),e.os=a("os");let t=e.runPythonInternal("import __main__; __main__.__dict__"),n=e.runPythonInternal("import builtins; builtins.__dict__");e.globals=re(t,n);let o=e._pyodide._importhook;function i(s){"__all__"in s||Object.defineProperty(s,"__all__",{get:()=>d.toPy(Object.getOwnPropertyNames(s).filter(u=>u!=="__all__")),enumerable:!1,configurable:!0})}h(i,"jsFinderHook"),o.register_js_finder.callKwargs({hook:i}),o.register_js_module("js",r.jsglobals);let d=e.makePublicAPI();return o.register_js_module("pyodide_js",d),e.pyodide_py=a("pyodide"),e.pyodide_code=a("pyodide.code"),e.pyodide_ffi=a("pyodide.ffi"),e.package_loader=a("pyodide._package_loader"),e.sitepackages=e.package_loader.SITE_PACKAGES.__str__(),e.dsodir=e.package_loader.DSO_DIR.__str__(),e.defaultLdLibraryPath=[e.dsodir,e.sitepackages],e.os.environ.__setitem__("LD_LIBRARY_PATH",e.defaultLdLibraryPath.join(":")),d.pyodide_py=e.pyodide_py,d.globals=e.globals,d}h(ie,"finalizeBootstrap");function ae(){if(typeof __dirname=="string")return __dirname;let e;try{throw new Error}catch(t){e=t}let r=_e.default.parse(e)[0].fileName,a=r.lastIndexOf(I);if(a===-1)throw new Error("Could not extract indexURL path from pyodide module location");return r.slice(0,a)}h(ae,"calculateIndexURL");async function A(e={}){await H();let r=e.indexURL||ae();r=F(r),r.endsWith("/")||(r+="/"),e.indexURL=r;let a={fullStdLib:!1,jsglobals:globalThis,stdin:globalThis.prompt?globalThis.prompt:void 0,lockFileURL:r+"pyodide-lock.json",args:[],_node_mounts:[],env:{},packageCacheDir:r,packages:[]},t=Object.assign(a,e);if(e.homedir){if(console.warn("The homedir argument to loadPyodide is deprecated. Use 'env: { HOME: value }' instead of 'homedir: value'."),e.env&&e.env.HOME)throw new Error("Set both env.HOME and homedir arguments");t.env.HOME=t.homedir}t.env.HOME||(t.env.HOME="/home/pyodide");let n=K();n.print=t.stdout,n.printErr=t.stderr,n.arguments=t.args;let o={config:t};n.API=o,te(n,r),ee(n,t);let i=new Promise(l=>n.postRun=l),d;if(o.bootstrapFinalizedPromise=new Promise(l=>d=l),n.locateFile=l=>t.indexURL+l,typeof _createPyodideModule!="function"){let l=`${t.indexURL}pyodide.asm.js`;await L(l)}if(await _createPyodideModule(n),await i,n.exited)throw n.exited.toThrow;if(o.version!==S)throw new Error(`Pyodide version does not match: '${S}' <==> '${o.version}'. If you updated the Pyodide version, make sure you also updated the 'indexURL' parameter passed to loadPyodide.`);n.locateFile=l=>{throw new Error("Didn't expect to load any more file_packager files!")};let[s,u]=o.rawRun("import _pyodide_core");s&&n.API.fatal_loading_error(`Failed to import _pyodide_core
`,u);let c=ie(o,t);if(d(),c.version.includes("dev")||o.setCdnUrl(`https://cdn.jsdelivr.net/pyodide/v${c.version}/full/`),await o.packageIndexReady,o._pyodide._importhook.register_module_not_found_hook(o._import_name_to_package_name,o.lockfile_unvendored_stdlibs_and_test),o.lockfile_info.version!==S)throw new Error("Lock file version doesn't match Pyodide version");return o.package_loader.init_loaded_packages(),t.fullStdLib&&await c.loadPackage(o.lockfile_unvendored_stdlibs),o.initializeStreams(t.stdin,t.stdout,t.stderr),c}h(A,"loadPyodide");const j={version:"0.24.1",loadMode:"cdn",localIndexURL:"/pyodide/v0.24.1/full/",cdnIndexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/",fallbackMode:"local",retryAttempts:3,timeout:3e4};async function ve(){try{const e=await fetch("/pyodide-config.json");if(e.ok){const r=await e.json();return{...j,...r}}}catch(e){console.warn("无法加载 pyodide-config.json，使用默认配置:",e)}return j}function _(e,r,a,t){const o=`${new Date().toISOString()} [${e}] [${r}] ${a}${t?` - ${b(t)}`:""}`;switch(e){case"DEBUG":console.debug(o);break;case"INFO":console.info(o);break;case"WARNING":console.warn(o);break;case"ERROR":console.error(o);break;case"CRITICAL":console.error(o);break}return o}function b(e){if(e==null)return String(e);if(typeof e=="string")return e.replace(/0x[0-9a-fA-F]+/g,"[内存地址]");if(typeof e=="object")try{return e.message&&typeof e.message=="string"?b(e.message):JSON.stringify(e).replace(/0x[0-9a-fA-F]+/g,"[内存地址]")}catch{return String(e).replace(/0x[0-9a-fA-F]+/g,"[内存地址]")}return String(e)}class P{constructor(){this.pyodide=null,this.isLoading=!1,this.loadPromise=null,this.installedPackages=new Set,this.loadingCallbacks=[],this.loadAttempts=0,this.maxLoadAttempts=3,this.config=null}static getInstance(){return P.instance||(P.instance=new P),P.instance}async getConfig(){return this.config||(this.config=await ve()),this.config}addLoadingCallback(r){this.loadingCallbacks.push(r)}removeLoadingCallback(r){this.loadingCallbacks=this.loadingCallbacks.filter(a=>a!==r)}triggerLoadingCallback(r,a,t){this.loadingCallbacks.forEach(n=>{try{n(r,a,t)}catch(o){console.error("加载回调执行失败:",o)}})}async loadPyodide(){if(this.pyodide)return this.pyodide;if(this.isLoading&&this.loadPromise)return this.loadPromise;this.isLoading=!0,this.loadAttempts=0,this.loadPromise=this.doLoadPyodideWithRetry();try{return this.pyodide=await this.loadPromise,this.triggerLoadingCallback("complete",100,"Python 环境初始化完成"),this.pyodide}finally{this.isLoading=!1,this.loadPromise=null}}async doLoadPyodideWithRetry(){for(;this.loadAttempts<this.maxLoadAttempts;){this.loadAttempts++;try{return await this.doLoadPyodide()}catch(r){if(console.error(`Pyodide 加载失败 (尝试 ${this.loadAttempts}/${this.maxLoadAttempts}):`,r),this.loadAttempts>=this.maxLoadAttempts)throw new Error(`Pyodide 加载失败，已重试 ${this.maxLoadAttempts} 次，请检查网络连接或稍后再试`);this.triggerLoadingCallback("retry",0,`Pyodide 加载失败，正在重试 (${this.loadAttempts}/${this.maxLoadAttempts})...`),await new Promise(a=>setTimeout(a,2e3*this.loadAttempts))}}throw new Error("Pyodide 加载失败，已超过最大重试次数")}async doLoadPyodide(){try{const r=await this.getConfig();this.maxLoadAttempts=r.retryAttempts,this.triggerLoadingCallback("init",0,"正在初始化 Python 环境...");let a=r.loadMode==="cdn"?r.cdnIndexURL:r.localIndexURL;_("INFO","PyodideManager",`正在从 ${r.loadMode} 模式加载 Pyodide v${r.version}`,a);const t=await A({indexURL:a,packages:[],onDownloadProgress:n=>{const o=Math.min(50,Math.round(n.loaded/(n.total||1)*50));this.triggerLoadingCallback("download",o,`正在下载 Python 核心组件... ${Math.round(o)}%`)}});return this.triggerLoadingCallback("init",50,"正在初始化 Python 解释器..."),await t.loadPackage("micropip"),this.installedPackages.add("micropip"),this.triggerLoadingCallback("init",75,"正在配置 Python 环境..."),await t.runPythonAsync("import sys, os, io, json, re"),this.triggerLoadingCallback("init",100,"Python 环境初始化完成"),_("INFO","PyodideManager","Pyodide 加载完成"),t}catch(r){const a=await this.getConfig();if(a.loadMode==="cdn"&&a.fallbackMode==="local"){_("WARNING","PyodideManager","CDN加载失败，尝试使用本地资源",r),this.triggerLoadingCallback("fallback",0,"CDN加载失败，正在尝试本地资源...");try{const t=await A({indexURL:a.localIndexURL,packages:[],onDownloadProgress:n=>{const o=Math.min(50,Math.round(n.loaded/(n.total||1)*50));this.triggerLoadingCallback("download",o,`正在从本地加载 Python 核心组件... ${Math.round(o)}%`)}});return this.triggerLoadingCallback("init",50,"正在初始化 Python 解释器..."),await t.loadPackage("micropip"),this.installedPackages.add("micropip"),this.triggerLoadingCallback("init",75,"正在配置 Python 环境..."),await t.runPythonAsync("import sys, os, io, json, re"),this.triggerLoadingCallback("init",100,"Python 环境初始化完成"),_("INFO","PyodideManager","Pyodide 本地加载完成"),t}catch(t){throw _("ERROR","PyodideManager","本地加载也失败",t),this.triggerLoadingCallback("error",0,`Pyodide 加载失败: ${b(t)}`),t}}throw this.triggerLoadingCallback("error",0,`Pyodide 加载失败: ${b(r)}`),_("ERROR","PyodideManager","Pyodide 加载失败",r),r}}async installPackages(r){const t=(await this.loadPyodide()).pyimport("micropip"),n=r.filter(o=>!this.installedPackages.has(o));if(n.length>0){this.triggerLoadingCallback("install",0,`正在安装依赖包: ${n.join(", ")}...`),_("INFO","PyodideManager",`安装依赖: ${n.join(", ")}`);const o=3;for(let i=0;i<n.length;i+=o){const d=n.slice(i,i+o),s=Math.round(i/n.length*100);this.triggerLoadingCallback("install",s,`正在安装依赖包 (${i+1}/${n.length})...`),await t.install(d),d.forEach(u=>this.installedPackages.add(u))}this.triggerLoadingCallback("install",100,"依赖包安装完成")}}isLoaded(){return this.pyodide!==null}getInstalledPackages(){return Array.from(this.installedPackages)}async dispose(){if(this.pyodide)try{await this.pyodide.runPythonAsync("import gc; gc.collect()"),this.pyodide=null,this.installedPackages.clear(),this.loadingCallbacks=[],_("INFO","PyodideManager","Pyodide 资源已清理")}catch(r){_("ERROR","PyodideManager","清理 Pyodide 资源失败",r)}}}const ke={basicExcel:["openpyxl"]};function Pe(e){var a;let r=[...ke.basicExcel];return e.type==="multiple"&&r.push("pandas"),e.type==="other"&&((a=e.data)!=null&&a.replaceImage)&&r.push("Pillow"),[...new Set(r)]}async function Oe(e,r,a){const t=P.getInstance(),n=[],o=Date.now();let i=null;try{if(a!=null&&a.loadingCallback,!(a!=null&&a.timeout))return await Ee(t,e,r,n,a==null?void 0:a.additionalDependencies)}catch(d){_("ERROR","runPy","Pyodide 执行错误",d);const s=Date.now()-o;return{success:!1,logs:[...n,`执行错误: ${b(d.message)}`,`总执行时间: ${s}ms`],error:b(d.message)}}finally{i&&clearTimeout(i)}}async function Ee(e,r,a,t,n){const o=Date.now();try{const i=await e.loadPyodide();t.push(`Pyodide 版本: ${i.version}`);let d=Pe(a);d.length>0&&(t.push(`安装依赖: ${d.join(", ")}...`),await e.installPackages(d),t.push("依赖安装完成"));let s={};a.type==="single"?s={file:a.file,fileName:a.fileName,settings:a.settings}:a.type==="multiple"?s={files:a.files,settings:a.settings}:s=a.data,i.globals.set("input_data",s),t.push("开始执行 Python 脚本..."),t.push(`脚本长度: ${r.length} 字符`);const u=Date.now();try{t.push(`执行环境: ${a.type} 类型输入`),a.type==="single"?t.push(`处理文件: ${a.fileName}`):a.type==="multiple"&&t.push(`处理文件数量: ${Object.keys(a.files).length}`),await i.runPythonAsync(r),t.push(`Python 脚本执行完成，耗时: ${Date.now()-u}ms`)}catch(m){const y=b(m.message);t.push(`Python 脚本执行错误: ${y}`);let f="未知错误";y.includes("ModuleNotFoundError")?(f="模块未找到错误",t.push("错误详情: 缺少必要的 Python 依赖包，请确保已正确安装所有依赖")):y.includes("FileNotFoundError")?(f="文件未找到错误",t.push("错误详情: 无法找到指定的文件，请检查文件路径是否正确")):y.includes("PermissionError")?(f="权限错误",t.push("错误详情: 没有足够的权限访问文件，请检查文件权限设置")):y.includes("ValueError")?(f="数值错误",t.push("错误详情: 输入参数无效或格式错误")):y.includes("TypeError")?(f="类型错误",t.push("错误详情: 函数参数类型不匹配")):y.includes("SyntaxError")&&(f="语法错误",t.push("错误详情: Python 脚本语法错误，请检查脚本代码")),t.push(`错误类型: ${f}`),m.stack&&t.push(`Python 错误堆栈: ${b(m.stack)}`);try{if(i.globals.has("sys")&&i.globals.get("sys").last_traceback){t.push("Python 详细堆栈跟踪:");try{if(i.runPython(`
import traceback
import sys
if hasattr(sys, 'last_traceback'):
    sys.last_traceback_str = ''.join(traceback.format_exception(*sys.exc_info()))
              `),i.globals.has("sys")&&i.globals.get("sys").last_traceback_str){let v=b(i.globals.get("sys").last_traceback_str);v=v.replace(/0x[0-9a-fA-F]+/g,"[内存地址]"),t.push(v)}}catch{t.push("无法获取详细堆栈跟踪")}}}catch(w){t.push(`获取错误详情失败: ${b(w.message)}`)}const g=Date.now()-u;throw t.push(`脚本执行失败，耗时: ${g}ms`),m}let c={};try{if(i.globals.has("process")){t.push("调用标准 process 函数...");const m=i.globals.get("process");try{c=m(s)}catch(y){throw t.push(`process 函数执行错误: ${y.message}`),y.stack&&t.push(`process 函数错误堆栈: ${y.stack}`),y}}else if(i.globals.has("merge_excel_files")){t.push("调用 merge_excel_files 函数...");const m=i.globals.get("merge_excel_files");if(a.type==="multiple")c=m(a.files,a.settings||{});else throw new Error("merge_excel_files 函数需要 multiple 类型的输入")}else i.globals.has("output")?(t.push("读取脚本式 output 变量..."),c=i.globals.get("output")):(t.push("未找到标准 process 函数或 output 变量，尝试从标准输出获取结果..."),c={success:!0,logs:["脚本执行完成"]})}catch(m){throw t.push(`获取结果时出错: ${b(m.message)}`),m}const l={success:!!c.success,logs:c.logs?Array.from(c.logs):t,details:c.details?JSON.parse(i.globals.JSON.stringify(c.details)):void 0,error:c.error?String(c.error):void 0};if(c.buffer){t.push("检测到返回的文件缓冲区");try{if(c.buffer instanceof Uint8Array)l.buffer=c.buffer.buffer,t.push(`文件缓冲区大小: ${l.buffer.byteLength} 字节`);else if(c.buffer.toJs){const m=c.buffer.toJs();l.buffer=m.buffer,t.push(`文件缓冲区大小: ${l.buffer.byteLength} 字节`)}else typeof c.buffer=="object"&&c.buffer.buffer?(l.buffer=c.buffer.buffer,t.push(`文件缓冲区大小: ${l.buffer.byteLength} 字节`)):(l.buffer=c.buffer,t.push(`文件缓冲区类型: ${typeof c.buffer}`))}catch(m){t.push(`处理文件缓冲区失败: ${b(m.message)}`),l.success=!1,l.error=l.error||"处理文件缓冲区时发生错误"}}else t.push("未检测到返回的文件缓冲区");if(l.success===void 0&&(l.success=!0,t.push("结果中未指定 success 字段，默认设置为 true")),Array.isArray(l.logs)||(t.push("结果中的 logs 不是数组，使用默认日志"),l.logs=t),!l.success&&!l.error){const m="处理失败，但未提供具体错误信息";l.error=m,t.push(m)}t.push(`处理结果: ${l.success?"成功":"失败"}`),l.success&&l.buffer?t.push("文件处理成功，生成了新的 Excel 文件"):l.success?t.push("处理成功，没有生成新文件"):t.push(`处理失败，错误信息: ${l.error}`);const p=Date.now()-o;return l.logs.push(`总执行时间: ${p}ms`),t.push(`平均处理速度: ${Math.round(p/Math.max(1,l.logs.length))}ms/步骤`),t.push("Python 脚本执行完成"),l}catch(i){_("ERROR","doRunPy","Pyodide 执行错误",i);const d=Date.now()-o;throw new Error(`执行错误: ${b(i.message)} (总执行时间: ${d}ms)`)}}export{Oe as r};
