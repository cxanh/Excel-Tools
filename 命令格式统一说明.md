# å‘½ä»¤æ ¼å¼ç»Ÿä¸€è¯´æ˜ âœ…

## å½“å‰å®ç°çŠ¶æ€

âœ… **å‘½ä»¤æ ¼å¼å·²ç»Ÿä¸€**

æ‰€æœ‰ä»æ¸²æŸ“è¿›ç¨‹å‘é€åˆ° Python åç«¯çš„å‘½ä»¤éƒ½ä½¿ç”¨ç»Ÿä¸€çš„æ ¼å¼ã€‚

## ç»Ÿä¸€çš„å‘½ä»¤æ ¼å¼

### æ ‡å‡†æ ¼å¼
```typescript
window.pythonBridge.sendCommand({
  action: 'action_name',
  params: {
    // å‚æ•°å¯¹è±¡
  }
})
```

### å®ç°æµç¨‹

```
æ¸²æŸ“è¿›ç¨‹ (Vue)
    â†“
window.pythonBridge.sendCommand()
    â†“
electron/preload.ts
    â†“
ipcRenderer.send('python-command', command)
    â†“
electron/main.ts
    â†“
ipcMain.on('python-command', ...)
    â†“
sendCommandToPython(command)
    â†“
pythonProcess.stdin.write(JSON.stringify(command) + '\n')
    â†“
Python åç«¯ (main.py)
    â†“
json.loads(line)
    â†“
router.route(command)
```

## ä»£ç å®ç°

### 1. Preload è„šæœ¬ (electron/preload.ts)

```typescript
const pythonBridge = {
  /**
   * å‘é€å‘½ä»¤åˆ° Python åç«¯
   * @param command - å‘½ä»¤å¯¹è±¡ï¼ŒåŒ…å« action å’Œ params
   */
  sendCommand: (command: { action: string; params: any }) => {
    ipcRenderer.send('python-command', command);
  },
  // ...
};

contextBridge.exposeInMainWorld('pythonBridge', pythonBridge);
```

### 2. ä¸»è¿›ç¨‹ (electron/main.ts)

```typescript
function registerIpcHandlers() {
  // å¤„ç†æ¥è‡ªæ¸²æŸ“è¿›ç¨‹çš„å‘½ä»¤
  ipcMain.on('python-command', (_event, command) => {
    console.log('[MAIN] Received command from renderer:', command);
    sendCommandToPython(command);
  });
  // ...
}

function sendCommandToPython(command: any): void {
  if (!pythonProcess || !pythonProcess.stdin) {
    console.error('[MAIN] Python process not available');
    return;
  }
  
  const commandJson = JSON.stringify(command) + '\n';
  pythonProcess.stdin.write(commandJson);
}
```

### 3. æ¸²æŸ“è¿›ç¨‹ (src/App.vue)

æ‰€æœ‰å‘½ä»¤éƒ½ä½¿ç”¨ç»Ÿä¸€æ ¼å¼ï¼š

```typescript
// åŠ è½½æ–‡ä»¶
window.pythonBridge.sendCommand({
  action: 'load_file',
  params: {
    file_path: fileStore.filePath
  }
});

// ä¿å­˜æ–‡ä»¶
window.pythonBridge.sendCommand({
  action: 'save_file',
  params: {
    file_path: fileStore.loadedFile.file_path,
    overwrite: true,
    create_backup: true
  }
});

// åˆ é™¤ç©ºç™½è¡Œ
window.pythonBridge.sendCommand({
  action: 'remove_blank_rows',
  params: {}
});

// æ›¿æ¢å†…å®¹
window.pythonBridge.sendCommand({
  action: 'replace_content',
  params: {
    find_text: replaceFind.value,
    replace_text: replaceWith.value,
    case_sensitive: replaceCaseSensitive.value,
    use_regex: replaceUseRegex.value
  }
});
```

## å‘½ä»¤åˆ—è¡¨

### æ–‡ä»¶æ“ä½œ
```typescript
// åŠ è½½æ–‡ä»¶
{ action: 'load_file', params: { file_path } }

// å…³é—­æ–‡ä»¶
{ action: 'close_file', params: {} }

// ä¿å­˜æ–‡ä»¶
{ action: 'save_file', params: { file_path, overwrite, create_backup } }
```

### å†…å®¹å¤„ç†
```typescript
// åˆ é™¤ç©ºç™½è¡Œ
{ action: 'remove_blank_rows', params: {} }

// æ¸…é™¤ç©ºç™½å•å…ƒæ ¼
{ action: 'clear_blank_cells', params: {} }

// åˆ é™¤å…¬å¼
{ action: 'remove_formulas', params: {} }

// åˆ é™¤é‡å¤è¡Œ
{ action: 'remove_duplicate_rows', params: {} }

// æ›¿æ¢å†…å®¹
{ action: 'replace_content', params: { find_text, replace_text, case_sensitive, use_regex } }
```

### å›¾åƒå¤„ç†
```typescript
// æå–å›¾ç‰‡
{ action: 'extract_images', params: { output_dir } }

// æ·»åŠ æ–‡å­—æ°´å°
{ action: 'add_text_watermark', params: { text, position, opacity } }

// æ·»åŠ å›¾ç‰‡æ°´å°
{ action: 'add_image_watermark', params: { watermark_image, position, opacity } }
```

### å·¥ä½œè¡¨ç®¡ç†
```typescript
// æ’å…¥å·¥ä½œè¡¨
{ action: 'insert_sheet', params: { sheet_name, position } }

// åˆ é™¤å·¥ä½œè¡¨
{ action: 'delete_sheet', params: { sheet_name } }

// é‡å‘½åå·¥ä½œè¡¨
{ action: 'rename_sheet', params: { old_name, new_name } }
```

### åˆå¹¶æ‹†åˆ†
```typescript
// åˆå¹¶ Excel æ–‡ä»¶
{ action: 'merge_excel_files', params: { input_files, output_file, mode } }

// æ‹†åˆ† Excel æ–‡ä»¶
{ action: 'split_excel_file', params: { input_file, rows_per_file, output_dir } }
```

### æ ¼å¼è½¬æ¢
```typescript
// Excel è½¬ PDF
{ action: 'excel_to_pdf', params: { input_file, output_file, sheet_range } }

// Excel è½¬ CSV
{ action: 'excel_to_csv', params: { input_file, output_dir, encoding } }
```

## å“åº”æ ¼å¼

### æˆåŠŸå“åº”
```json
{
  "type": "result",
  "status": "success",
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    // è¿”å›æ•°æ®
  }
}
```

### é”™è¯¯å“åº”
```json
{
  "type": "result",
  "status": "error",
  "error_code": "ERROR_CODE",
  "message": "é”™è¯¯æè¿°",
  "suggested_action": "å»ºè®®çš„è§£å†³æ–¹æ¡ˆ"
}
```

### è¿›åº¦æ›´æ–°
```json
{
  "type": "progress",
  "progress": 50,
  "message": "æ­£åœ¨å¤„ç†..."
}
```

### å¯åŠ¨æ¶ˆæ¯
```json
{
  "type": "startup",
  "status": "ready",
  "message": "Backend initialized successfully"
}
```

## ç±»å‹å®šä¹‰

### TypeScript ç±»å‹
```typescript
// å‘½ä»¤ç±»å‹
interface Command {
  action: string;
  params: Record<string, any>;
}

// å“åº”ç±»å‹
interface Response {
  type: 'result' | 'progress' | 'startup';
  status?: 'success' | 'error' | 'ready';
  message?: string;
  data?: any;
  error_code?: string;
  suggested_action?: string;
  progress?: number;
}
```

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **å§‹ç»ˆä½¿ç”¨ pythonBridge.sendCommand()**
   ```typescript
   window.pythonBridge.sendCommand({
     action: 'load_file',
     params: { file_path }
   });
   ```

2. **params å§‹ç»ˆæ˜¯å¯¹è±¡**
   ```typescript
   // âœ… æ­£ç¡®
   params: {}
   params: { file_path: 'path/to/file' }
   
   // âŒ é”™è¯¯
   params: null
   params: undefined
   ```

3. **action ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å**
   ```typescript
   // âœ… æ­£ç¡®
   action: 'load_file'
   action: 'remove_blank_rows'
   
   // âŒ é”™è¯¯
   action: 'loadFile'
   action: 'removeBlankRows'
   ```

4. **æ·»åŠ æ—¥å¿—è®°å½•**
   ```typescript
   historyStore.addLog('info', 'æ­£åœ¨åŠ è½½æ–‡ä»¶...');
   window.pythonBridge.sendCommand({
     action: 'load_file',
     params: { file_path }
   });
   ```

### âŒ é¿å…åšæ³•

1. **ä¸è¦ç›´æ¥ä½¿ç”¨ ipcRenderer**
   ```typescript
   // âŒ é”™è¯¯
   ipcRenderer.send('python-command', command);
   
   // âœ… æ­£ç¡®
   window.pythonBridge.sendCommand(command);
   ```

2. **ä¸è¦çœç•¥ params**
   ```typescript
   // âŒ é”™è¯¯
   window.pythonBridge.sendCommand({
     action: 'close_file'
   });
   
   // âœ… æ­£ç¡®
   window.pythonBridge.sendCommand({
     action: 'close_file',
     params: {}
   });
   ```

3. **ä¸è¦åœ¨å‘½ä»¤ä¸­æ·»åŠ é¢å¤–å­—æ®µ**
   ```typescript
   // âŒ é”™è¯¯
   window.pythonBridge.sendCommand({
     action: 'load_file',
     params: { file_path },
     timestamp: Date.now(),  // é¢å¤–å­—æ®µ
     user: 'admin'           // é¢å¤–å­—æ®µ
   });
   
   // âœ… æ­£ç¡®
   window.pythonBridge.sendCommand({
     action: 'load_file',
     params: { file_path }
   });
   ```

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å‘é€çš„å‘½ä»¤
åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹ï¼š
```
[MAIN] Received command from renderer: { action: 'load_file', params: {...} }
```

### 2. æŸ¥çœ‹ Python æ¥æ”¶çš„å‘½ä»¤
åœ¨ç»ˆç«¯æŸ¥çœ‹ï¼š
```
[BACKEND] Received command: load_file
```

### 3. æŸ¥çœ‹å“åº”
åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ï¼š
```
[PYTHON] { type: 'result', status: 'success', ... }
```

## æ·»åŠ æ–°å‘½ä»¤

### æ­¥éª¤ 1ï¼šåœ¨ Python åç«¯æ·»åŠ å¤„ç†å™¨
```python
# python-backend/cli_router.py
def route(self, command):
    action = command.get('action')
    params = command.get('params', {})
    
    if action == 'new_action':
        return self.handle_new_action(params)
```

### æ­¥éª¤ 2ï¼šåœ¨å‰ç«¯è°ƒç”¨
```typescript
// src/App.vue
function newAction() {
  fileStore.setLoading(true);
  historyStore.addLog('info', 'æ­£åœ¨æ‰§è¡Œæ–°æ“ä½œ...');
  
  window.pythonBridge.sendCommand({
    action: 'new_action',
    params: {
      param1: value1,
      param2: value2
    }
  });
}
```

### æ­¥éª¤ 3ï¼šå¤„ç†å“åº”
```typescript
// src/App.vue
function handlePythonMessage(message: any) {
  if (message.type === 'result') {
    if (message.status === 'success') {
      historyStore.addLog('success', message.message);
      // å¤„ç†æˆåŠŸé€»è¾‘
    } else {
      historyStore.addLog('error', message.message);
      // å¤„ç†é”™è¯¯é€»è¾‘
    }
  }
}
```

## æ€»ç»“

âœ… **å‘½ä»¤æ ¼å¼å·²ç»Ÿä¸€**
- æ‰€æœ‰å‘½ä»¤ä½¿ç”¨ `window.pythonBridge.sendCommand()`
- æ ¼å¼ï¼š`{ action: string, params: object }`
- ç±»å‹å®‰å…¨ï¼Œæ˜“äºç»´æŠ¤

ğŸ¯ **ä¼˜åŠ¿**
- ç»Ÿä¸€çš„æ¥å£
- ç±»å‹æ£€æŸ¥
- æ˜“äºè°ƒè¯•
- æ˜“äºæ‰©å±•

ğŸ“ **æ³¨æ„äº‹é¡¹**
- å§‹ç»ˆä½¿ç”¨ pythonBridge API
- params å¿…é¡»æ˜¯å¯¹è±¡
- action ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
- æ·»åŠ é€‚å½“çš„æ—¥å¿—

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2026-01-19  
**çŠ¶æ€**: âœ… å·²ç»Ÿä¸€

